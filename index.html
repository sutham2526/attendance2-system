<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>üìò ‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</title>
  <link href="https://fonts.googleapis.com/css2?family=Sarabun&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: 'Sarabun', sans-serif;
      background: #f5f7fa;
      margin: 0;
      padding: 20px;
    }
    h2 { text-align:center; margin-bottom:20px; color:#2c3e50; }

    /* ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏°‡∏ô‡∏π‡∏´‡∏•‡∏±‡∏Å */
    .menu-bar { display:flex; justify-content:center; gap:15px; margin-bottom:20px; }
    .menu-bar button {
      padding:15px 25px; font-size:18px; font-weight:bold;
      border:none; border-radius:12px; cursor:pointer; color:#fff;
      transition:0.3s;
    }
    .menu-bar button:nth-child(1){ background:linear-gradient(45deg,#27ae60,#2ecc71); }
    .menu-bar button:nth-child(2){ background:linear-gradient(45deg,#2980b9,#3498db); }
    .menu-bar button:nth-child(3){ background:linear-gradient(45deg,#8e44ad,#9b59b6); }
    .menu-bar button:nth-child(4){ background:linear-gradient(45deg,#e67e22,#f39c12); }
    .menu-bar button:hover{ transform:scale(1.05); }

    /* ‡∏Å‡∏•‡πà‡∏≠‡∏á‡πÄ‡∏°‡∏ô‡∏π */
    .menu {
      display:none; padding:20px; background:#fff; border-radius:16px;
      box-shadow:0 4px 10px rgba(0,0,0,0.1); margin-bottom:20px;
    }

    /* ‡∏õ‡∏∏‡πà‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ */
    .status-btn {
      display:inline-block; margin:3px; padding:10px 14px; border-radius:50%;
      color:#fff; cursor:pointer; font-weight:bold; opacity:0.4;
    }
    .status-btn.active { opacity:1; }
    .‡∏°‡∏≤ { background:#27ae60; }
    .‡∏Ç‡∏≤‡∏î { background:#c0392b; }
    .‡∏•‡∏≤‡∏Å‡∏¥‡∏à { background:#8e44ad; }
    .‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢ { background:#e67e22; }
    .‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° { background:#f1c40f; color:#000; }

    /* ‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÄ‡∏•‡∏∑‡∏≠‡∏Å */
    select, input[type=date], button.action {
      font-family:'Sarabun',sans-serif; font-size:18px; padding:6px 10px;
      margin:5px; border-radius:8px; border:1px solid #ccc;
    }
    button.action {
      background:linear-gradient(45deg,#16a085,#1abc9c); color:#fff;
      font-weight:bold; border:none; cursor:pointer; transition:0.2s;
    }
    button.action:hover { transform:scale(1.05); }

    /* ‡∏ï‡∏≤‡∏£‡∏≤‡∏á */
    table {
      width:100%; border-collapse:collapse; margin-top:15px;
    }
    th, td {
      border:1px solid #ddd; padding:10px; text-align:center;
      font-size:16px;
    }
    th { background:#3498db; color:#fff; }
    tr:nth-child(even){ background:#f9f9f9; }
    tr:hover{ background:#ecf0f1; }

    .card {
      padding:15px; border-radius:12px; background:#fff;
      box-shadow:0 2px 8px rgba(0,0,0,0.1); margin-bottom:15px;
    }
  </style>
</head>
<body>

  <h2>üìò ‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h2>

  <!-- ‡πÄ‡∏°‡∏ô‡∏π‡∏´‡∏•‡∏±‡∏Å -->
  <div class="menu-bar">
    <button onclick="showTab('menu1')">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</button>
    <button onclick="showTab('menu2')">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
    <button onclick="showTab('menu3')">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</button>
    <button onclick="showTab('menu4')">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•</button>
  </div>

  <!-- ‡πÄ‡∏°‡∏ô‡∏π 1 -->
  <div id="menu1" class="menu">
    <h3>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h3>
    <div class="card">
      <label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: </label>
      <input type="date" id="dateInput">
      <label>‡∏´‡πâ‡∏≠‡∏á: </label>
      <select id="roomSelect" onchange="resetAttendance()"></select>
      <label>‡∏ß‡∏¥‡∏ä‡∏≤: </label>
      <select id="subjectSelect" onchange="resetAttendance()"></select>
      <button class="action" onclick="checkAndLoadStudents()">‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠</button>
    </div>
    <div id="studentList"></div>
    <button class="action" onclick="saveAttendance()">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
  </div>

  <!-- ‡πÄ‡∏°‡∏ô‡∏π 2 -->
  <div id="menu2" class="menu">
    <h3>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h3>
    <div class="card">
      <h4>‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h4>
      <input type="text" id="newRoom" placeholder="‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÉ‡∏´‡∏°‡πà">
      <button class="action">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°</button>
      <input type="file" id="excelUpload" accept=".xlsx,.xls">
      <button class="action" onclick="importExcel()">üì• ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏à‡∏≤‡∏Å Excel</button>
      <div id="roomManage"></div>
    </div>
    <div class="card">
      <h4>‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤</h4>
      <input type="text" id="newSubject" placeholder="‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤‡πÉ‡∏´‡∏°‡πà">
      <button class="action">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°</button>
      <div id="subjectManage"></div>
    </div>
  </div>

  <!-- ‡πÄ‡∏°‡∏ô‡∏π 3 -->
  <div id="menu3" class="menu">
    <h3>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h3>
    <div class="card">
      <input type="date" id="historyDate">
      ‡∏´‡πâ‡∏≠‡∏á: <select id="historyRoom"></select>
      ‡∏ß‡∏¥‡∏ä‡∏≤: <select id="historySubject"></select>
      <button class="action" onclick="loadHistory()">‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
    </div>
    <div id="historyTable"></div>
  </div>

  <!-- ‡πÄ‡∏°‡∏ô‡∏π 4 -->
  <div id="menu4" class="menu">
    <h3>‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•</h3>
    <canvas id="reportChart" height="120"></canvas>
  </div>

<script>
  const scriptUrl = "https://script.google.com/macros/s/AKfycbyAUDEJkFnG-ZwCws0X-RGlST_MOhAwcW4ffn5jO51094vrmcEjjUJR7WTI6zo2Abpu/exec";

  function showTab(tab){
    document.querySelectorAll(".menu").forEach(m=>m.style.display="none");
    document.getElementById(tab).style.display="block";
  }

  // ‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏ß‡∏±‡∏ô‡πÉ‡∏ô‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô
  document.addEventListener("DOMContentLoaded",()=>{
    let today=new Date().toISOString().split('T')[0];
    document.getElementById("dateInput").setAttribute("max",today);
    loadRooms(); loadSubjects();
  });

  function resetAttendance(){
    document.getElementById("studentList").innerHTML="";
  }

  function checkAndLoadStudents(){
    let d=document.getElementById("dateInput").value;
    let r=document.getElementById("roomSelect").value;
    let s=document.getElementById("subjectSelect").value;
    if(d && r && s){
      loadStudents();
    } else {
      Swal.fire("‚ö†Ô∏è","‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ‡∏´‡πâ‡∏≠‡∏á ‡πÅ‡∏•‡∏∞‡∏ß‡∏¥‡∏ä‡∏≤ ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö","warning");
    }
  }

  function loadRooms(){
    fetch(scriptUrl+"?action=getRooms")
      .then(r=>r.json()).then(data=>{
        let sel=document.getElementById("roomSelect");
        sel.innerHTML="<option value=''>--‡πÄ‡∏•‡∏∑‡∏≠‡∏Å--</option>";
        data.forEach(r=> sel.innerHTML+=`<option>${r}</option>`);
        document.getElementById("historyRoom").innerHTML=sel.innerHTML;
      });
  }
  function loadSubjects(){
    fetch(scriptUrl+"?action=getSubjects")
      .then(r=>r.json()).then(data=>{
        let sel=document.getElementById("subjectSelect");
        sel.innerHTML="<option value=''>--‡πÄ‡∏•‡∏∑‡∏≠‡∏Å--</option>";
        data.forEach(r=> sel.innerHTML+=`<option>${r}</option>`);
        document.getElementById("historySubject").innerHTML=sel.innerHTML;
      });
  }

  function loadStudents(){
    let room=document.getElementById("roomSelect").value;
    fetch(scriptUrl+`?action=getStudents&room=${room}`)
      .then(r=>r.json()).then(data=>{
        let div=document.getElementById("studentList"); div.innerHTML="";
        data.forEach(st=>{
          div.innerHTML+=`
            <div>
              ${st.number} | ${st.id} | ${st.name}
              <span class="status-btn ‡∏°‡∏≤ active" onclick="toggleStatus(this,'‡∏°‡∏≤')">/</span>
              <span class="status-btn ‡∏Ç‡∏≤‡∏î" onclick="toggleStatus(this,'‡∏Ç‡∏≤‡∏î')">‡∏Ç</span>
              <span class="status-btn ‡∏•‡∏≤‡∏Å‡∏¥‡∏à" onclick="toggleStatus(this,'‡∏•‡∏≤‡∏Å‡∏¥‡∏à')">‡∏•</span>
              <span class="status-btn ‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢" onclick="toggleStatus(this,'‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢')">‡∏õ</span>
              <span class="status-btn ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°" onclick="toggleStatus(this,'‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°')">‡∏Å</span>
            </div>`;
        });
      });
  }

  function toggleStatus(el,status){
    el.parentNode.querySelectorAll(".status-btn").forEach(b=>b.classList.remove("active"));
    el.classList.add("active");
    el.setAttribute("data-status",status);
  }

  function saveAttendance(){
    Swal.fire({title:"‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...",allowOutsideClick:false,didOpen:()=>Swal.showLoading()});
    let date=document.getElementById("dateInput").value;
    let room=document.getElementById("roomSelect").value;
    let subject=document.getElementById("subjectSelect").value;
    let rows=[];
    document.querySelectorAll("#studentList div").forEach(d=>{
      let parts=d.innerText.split("|");
      let st=d.querySelector("[data-status]");
      let status=st?st.getAttribute("data-status"):"‡∏°‡∏≤";
      rows.push({date,room,subject,number:parts[0].trim(),studentId:parts[1].trim(),name:parts[2].trim(),status});
    });
    fetch(scriptUrl,{
      method:"POST",body:JSON.stringify({action:"saveAttendance",rows})
    }).then(r=>r.json()).then(res=>{
      Swal.fire("‚úÖ",res.message,"success");
    });
  }

  function loadHistory(){
    let date=document.getElementById("historyDate").value;
    let room=document.getElementById("historyRoom").value;
    let subject=document.getElementById("historySubject").value;
    fetch(scriptUrl+`?action=getHistory&date=${date}&room=${room}&subject=${subject}`)
      .then(r=>r.json()).then(data=>{
        let html="<table><tr><th>‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà</th><th>‡∏£‡∏´‡∏±‡∏™</th><th>‡∏ä‡∏∑‡πà‡∏≠</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th></tr>";
        data.forEach(r=> html+=`<tr><td>${r.number}</td><td>${r.id}</td><td>${r.name}</td><td>${r.status}</td></tr>`);
        html+="</table>";
        document.getElementById("historyTable").innerHTML=html;
      });
  }

  // üìä ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏£‡∏∏‡∏õ
  function loadReport(){
    fetch(scriptUrl+"?action=getReport")
      .then(r=>r.json()).then(data=>{
        let ctx=document.getElementById("reportChart").getContext("2d");
        new Chart(ctx,{
          type:"pie",
          data:{
            labels:["‡∏°‡∏≤","‡∏Ç‡∏≤‡∏î","‡∏•‡∏≤‡∏Å‡∏¥‡∏à","‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢","‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°"],
            datasets:[{
              data:[data.‡∏°‡∏≤,data.‡∏Ç‡∏≤‡∏î,data.‡∏•‡∏≤‡∏Å‡∏¥‡∏à,data.‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢,data.‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°],
              backgroundColor:["#27ae60","#c0392b","#8e44ad","#e67e22","#f1c40f"]
            }]
          }
        });
      });
  }
</script>

</body>
</html>
