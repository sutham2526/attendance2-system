<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>üéì ‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô ‚Äî Classroom Dashboard</title>

<!-- Fonts & Libs -->
<link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<style>
:root{
  --bg:#f3f6fb; --card:#ffffff; --ink:#222; --muted:#6b7280;
  --primary:#6a5acd; --primary2:#00c6ff; --accent:#ff6b6b;
  --grad: linear-gradient(90deg,#6a5acd,#00c6ff);
  --green:#27ae60; --red:#c0392b; --yellow:#f1c40f; --purple:#8e44ad; --orange:#e67e22; --amber:#f39c12;
  --radius:16px;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  font-family:'Sarabun',system-ui,-apple-system,Segoe UI,Roboto,Arial;
  margin:0;background:var(--bg); color:var(--ink);
}
header{
  background:var(--grad); color:#fff; padding:18px 20px; text-align:center;
  box-shadow:0 6px 20px rgba(0,0,0,.15);
}
header .title{font-size:22px; font-weight:700; letter-spacing:.3px}
.topbar{
  display:flex; gap:10px; justify-content:center; flex-wrap:wrap;
  padding:14px 12px; background:#fff; position:sticky; top:0; z-index:5;
  box-shadow:0 2px 10px rgba(0,0,0,.06);
}
.btn{
  border:0; padding:10px 16px; border-radius:12px; cursor:pointer; font-weight:600;
  background:var(--grad); color:#fff; transition:.2s; box-shadow:0 4px 10px rgba(0,0,0,.12);
}
.btn.secondary{ background:#eef2ff; color:#3b82f6; box-shadow:none; }
.btn.warn{ background:#ffe8e8; color:#e11d48; }
.btn:hover{ filter:brightness(.95); transform:translateY(-1px) }

.container{max-width:1200px; margin:20px auto; padding:0 16px}
section{display:none}
section.active{display:block}

.card{
  background:var(--card); border-radius:var(--radius); padding:20px; margin-bottom:18px;
  box-shadow:0 8px 24px rgba(0,0,0,.08);
}
.card h3{margin:0 0 12px 0}

.row{display:flex; gap:12px; flex-wrap:wrap; align-items:center}
.row > *{flex:0 0 auto}
input[type="text"], input[type="number"], input[type="date"], select{
  padding:10px 12px; border-radius:12px; border:1px solid #e5e7eb; background:#fff; min-width:180px;
}
input[type="file"]{border:1px dashed #cbd5e1; padding:10px; border-radius:12px; background:#f8fafc}
label{color:var(--muted); font-weight:600; margin-right:6px}

.table-wrap{overflow:auto; border-radius:14px; box-shadow:0 3px 12px rgba(0,0,0,.06)}
table{width:100%; border-collapse:separate; border-spacing:0; background:#fff}
th,td{padding:10px 12px; text-align:left; border-bottom:1px solid #f1f5f9}
th{background:#f8fafc; color:#334155; position:sticky; top:0; z-index:1}
tr:last-child td{border-bottom:0}
tr:nth-child(even) td{background:#fcfdff}

.badge{
  padding:6px 10px; background:#eef2ff; color:#4f46e5; border-radius:999px; font-size:12px; font-weight:700
}

/* status buttons (circle) */
.status-btn{
  display:inline-grid; place-items:center; width:36px; height:36px; border-radius:50%;
  color:#fff; font-weight:800; margin-right:6px; opacity:.35; cursor:pointer; border:2px solid transparent;
  transition:.15s;
}
.status-btn:hover{ transform:scale(1.03) }
.status-btn.active{ opacity:1; box-shadow:0 0 0 3px rgba(0,0,0,.06) }
.‡∏°‡∏≤{ background:var(--green) }
.‡∏Ç‡∏≤‡∏î{ background:var(--red) }
.‡∏™‡∏≤‡∏¢{ background:var(--yellow); color:#111 }
.‡∏•‡∏≤‡∏Å‡∏¥‡∏à{ background:var(--purple) }
.‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢{ background:var(--orange) }
.‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°{ background:var(--amber); color:#111 }

/* mini tabs inside Manage */
.subtabs{display:flex; gap:8px; margin-bottom:12px}
.subtabs .tab{padding:8px 12px; border-radius:10px; background:#eef2ff; color:#334155; cursor:pointer; font-weight:600}
.subtabs .tab.active{background:var(--grad); color:#fff}

/* Import preview modal (use SweetAlert HTML) */
.preview-table{max-height:50vh; overflow:auto; text-align:left}
.preview-table table{min-width:520px}
.footer-actions{display:flex; gap:10px; justify-content:flex-end; margin-top:10px}
.note{color:#64748b; font-size:12px}
.kpi{display:grid; grid-template-columns:repeat(3,minmax(0,1fr)); gap:12px}
.kpi .card{display:flex; align-items:center; gap:12px}
.kpi .dot{width:14px; height:14px; border-radius:50%}
</style>
</head>
<body>

<header>
  <div class="title">üéì ‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô ‚Äî Classroom Dashboard</div>
</header>

<div class="topbar">
  <button class="btn" onclick="openSection('attendance')">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</button>
  <button class="btn" onclick="openSection('manage')">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
  <button class="btn" onclick="openSection('history')">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ & ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</button>
</div>

<div class="container">

  <!-- ============ SECTION: Attendance ============ -->
  <section id="attendance" class="active">
    <div class="card">
      <h3>üìå ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h3>
      <div class="row">
        <div>
          <label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label><br/>
          <input type="date" id="attDate" />
          <div class="note">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞ ‚Äú‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‚Äù ‡∏´‡∏£‡∏∑‡∏≠ ‚Äú‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á‚Äù</div>
        </div>
        <div>
          <label>‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</label><br/>
          <select id="attRoom"></select>
        </div>
        <div>
          <label>‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤</label><br/>
          <select id="attSubject"></select>
        </div>
        <div>
          <br/>
          <button class="btn" onclick="loadStudentsForAttendance()">‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠</button>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="row" style="justify-content:space-between; align-items:center">
        <h3 style="margin:0">‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h3>
        <span class="badge" id="attCount">‚Äî</span>
      </div>
      <div class="table-wrap" id="attTableWrap">
        <table id="attTable">
          <thead>
            <tr>
              <th style="width:80px">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà</th>
              <th style="width:140px">‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß</th>
              <th>‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•</th>
              <th style="min-width:320px">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ (‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å)</th>
            </tr>
          </thead>
          <tbody id="attBody"></tbody>
        </table>
      </div>
      <div class="footer-actions">
        <button class="btn" onclick="saveAttendance()">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
      </div>
    </div>
  </section>

  <!-- ============ SECTION: Manage ============ -->
  <section id="manage">
    <div class="card">
      <div class="subtabs">
        <div class="tab active" id="tab-classes" onclick="switchManageTab('classes')">üè´ ‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô & ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</div>
        <div class="tab" id="tab-subjects" onclick="switchManageTab('subjects')">üìö ‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤</div>
      </div>

      <!-- Classes panel -->
      <div id="panel-classes">
        <div class="row">
          <input type="text" id="newClassName" placeholder="‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ä‡∏∑‡πà‡∏≠‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÉ‡∏´‡∏°‡πà ‡πÄ‡∏ä‡πà‡∏ô ‡∏°.3/1" />
          <button class="btn" onclick="addClass()">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
          <button class="btn secondary" onclick="saveAllClasses()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á Google Sheet</button>
          <button class="btn warn" onclick="deleteAllClasses()">‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
        </div>

        <div id="classCards" style="margin-top:10px"></div>
      </div>

      <!-- Subjects panel -->
      <div id="panel-subjects" style="display:none">
        <div class="row">
          <input type="text" id="newSubject" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤‡πÉ‡∏´‡∏°‡πà ‡πÄ‡∏ä‡πà‡∏ô ‡∏Ñ‡∏ì‡∏¥‡∏ï‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå" />
          <button class="btn" onclick="addSubject()">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
          <button class="btn secondary" onclick="saveAllSubjects()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á Google Sheet</button>
          <button class="btn warn" onclick="deleteAllSubjects()">‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
        </div>
        <div id="subjectCards" style="margin-top:10px"></div>
      </div>
    </div>
  </section>

  <!-- ============ SECTION: History & Report ============ -->
  <section id="history">
    <div class="card">
      <h3>üóÇÔ∏è ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h3>
      <div class="row">
        <div>
          <label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label><br/>
          <input type="date" id="hisDate" />
          <div class="note">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡πÄ‡∏Ñ‡∏¢‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏à‡∏∞‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏≤‡∏Å‡∏è‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á</div>
        </div>
        <div>
          <label>‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</label><br/>
          <select id="hisRoom"></select>
        </div>
        <div>
          <label>‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤</label><br/>
          <select id="hisSubject"></select>
        </div>
        <div>
          <br/>
          <button class="btn" onclick="loadHistory()">‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
        </div>
      </div>
    </div>

    <div class="card">
      <h3 style="margin:0 0 12px">‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á</h3>
      <div class="table-wrap">
        <table id="hisTable">
          <thead>
            <tr>
              <th style="width:80px">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà</th>
              <th style="width:140px">‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß</th>
              <th>‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•</th>
              <th style="width:140px">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
            </tr>
          </thead>
          <tbody id="hisBody"></tbody>
        </table>
      </div>
    </div>

    <div class="card">
      <h3>üìä ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏• (6 ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞)</h3>

      <div class="kpi">
        <div class="card"><div class="dot" style="background:var(--green)"></div><div><b>‡∏°‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</b><div id="kpi-present">0</div></div></div>
        <div class="card"><div class="dot" style="background:var(--red)"></div><div><b>‡∏Ç‡∏≤‡∏î</b><div id="kpi-absent">0</div></div></div>
        <div class="card"><div class="dot" style="background:var(--yellow)"></div><div><b>‡∏™‡∏≤‡∏¢</b><div id="kpi-late">0</div></div></div>
      </div>

      <div class="table-wrap" style="margin-top:14px">
        <table id="repTable">
          <thead>
            <tr>
              <th>‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•</th>
              <th>‡∏°‡∏≤</th><th>‡∏Ç‡∏≤‡∏î</th><th>‡∏™‡∏≤‡∏¢</th><th>‡∏•‡∏≤‡∏Å‡∏¥‡∏à</th><th>‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢</th><th>‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</th>
              <th>% ‡∏°‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</th>
            </tr>
          </thead>
          <tbody id="repBody"></tbody>
        </table>
      </div>

      <div style="margin:14px 0">
        <canvas id="repChart" height="220"></canvas>
      </div>

      <div class="footer-actions">
        <button class="btn secondary" onclick="exportExcel()">Export Excel</button>
        <button class="btn secondary" onclick="exportPDF()">Export PDF</button>
      </div>
    </div>
  </section>

</div>

<script>
/* =========================
   Config & Utilities
========================= */
const API_BASE = "https://script.google.com/macros/s/AKfycbyAUDEJkFnG-ZwCws0X-RGlST_MOhAwcW4ffn5jO51094vrmcEjjUJR7WTI6zo2Abpu/exec";

// JSONP helper
function jsonp(params){
  return new Promise((resolve,reject)=>{
    const cb = 'cb_' + Math.random().toString(36).slice(2);
    const script = document.createElement('script');
    const url = API_BASE + (API_BASE.includes('?') ? '&':'?') + params + `&callback=${cb}`;
    window[cb] = (data)=>{ resolve(data); cleanup(); };
    script.onerror = ()=>{ reject(new Error('JSONP error')); cleanup(); };
    function cleanup(){
      delete window[cb];
      script.remove();
    }
    script.src = url;
    document.body.appendChild(script);
  });
}

// Date limit: only today or past
function initDateLimits(){
  const today = new Date().toISOString().split('T')[0];
  ['attDate','hisDate'].forEach(id=>{
    const el = document.getElementById(id);
    el.max = today;
    if(!el.value) el.value = today;
    el.addEventListener('change', ()=>{
      if(el.value > today){ el.value = today; }
    });
  });
}

// Shared state
let ROOMS = [];             // [{name}]
let SUBJECTS = [];          // [name]
let STUDENTS_BY_ROOM = {};  // { room: [{number,id,name}] }
let CURRENT_ATT = [];       // [{number,id,name,status}]

/* =========================
   Boot
========================= */
openSection('attendance');
initDateLimits();
loadAllMaster();

function openSection(id){
  document.querySelectorAll('section').forEach(s=>s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  // refresh selects
  if(id==='attendance'){ fillSelects('attRoom','attSubject'); }
  if(id==='history'){ fillSelects('hisRoom','hisSubject'); }
}

// load rooms/subjects/students from GAS
async function loadAllMaster(){
  try{
    const data = await jsonp('action=getAll');
    ROOMS = data.rooms || [];
    SUBJECTS = data.subjects || [];
    STUDENTS_BY_ROOM = data.studentsByRoom || {};
    renderClassCards();
    renderSubjectCards();
    fillSelects('attRoom','attSubject');
    fillSelects('hisRoom','hisSubject');
  }catch(e){
    console.error(e);
    // fallback: empty state
  }
}

function fillSelects(roomSelId, subjectSelId){
  const rs = document.getElementById(roomSelId), ss = document.getElementById(subjectSelId);
  if(rs){ rs.innerHTML = `<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô --</option>` + ROOMS.map(r=>`<option value="${r.name}">${r.name}</option>`).join(''); }
  if(ss){ ss.innerHTML = `<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤ --</option>` + SUBJECTS.map(s=>`<option value="${s}">${s}</option>`).join(''); }
}

/* =========================
   Attendance
========================= */
function loadStudentsForAttendance(){
  const room = document.getElementById('attRoom').value;
  const subject = document.getElementById('attSubject').value;
  if(!room || !subject){ Swal.fire('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÅ‡∏•‡∏∞‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤'); return; }
  const list = (STUDENTS_BY_ROOM[room] || []).slice().sort((a,b)=>Number(a.number)-Number(b.number));
  CURRENT_ATT = list.map(x=>({...x, status:'‡∏Ç‡∏≤‡∏î'}));
  renderAttTable();
}
function renderAttTable(){
  const tbody = document.getElementById('attBody');
  tbody.innerHTML = '';
  CURRENT_ATT.forEach((s,i)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${s.number}</td>
      <td>${s.id}</td>
      <td>${s.name}</td>
      <td>
        <span class="status-btn ‡∏°‡∏≤" onclick="setStatus(${i},'‡∏°‡∏≤')">/</span>
        <span class="status-btn ‡∏Ç‡∏≤‡∏î active" onclick="setStatus(${i},'‡∏Ç‡∏≤‡∏î')">‡∏Ç</span>
        <span class="status-btn ‡∏™‡∏≤‡∏¢" onclick="setStatus(${i},'‡∏™‡∏≤‡∏¢')">‡∏™</span>
        <span class="status-btn ‡∏•‡∏≤‡∏Å‡∏¥‡∏à" onclick="setStatus(${i},'‡∏•‡∏≤‡∏Å‡∏¥‡∏à')">‡∏•</span>
        <span class="status-btn ‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢" onclick="setStatus(${i},'‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢')">‡∏õ</span>
        <span class="status-btn ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°" onclick="setStatus(${i},'‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°')">‡∏Å</span>
      </td>
    `;
    tbody.appendChild(tr);
  });
  document.getElementById('attCount').textContent = `${CURRENT_ATT.length} ‡∏Ñ‡∏ô`;
  refreshAttStatusUI();
}
function setStatus(idx, st){
  CURRENT_ATT[idx].status = st;
  refreshAttStatusUI();
}
function refreshAttStatusUI(){
  const rows = document.querySelectorAll('#attBody tr');
  CURRENT_ATT.forEach((s,i)=>{
    const btns = rows[i].querySelectorAll('.status-btn');
    btns.forEach(b=>{
      b.classList.remove('active');
      if(b.classList.contains(s.status)) b.classList.add('active');
    });
  });
}
async function saveAttendance(){
  const date = document.getElementById('attDate').value;
  const room = document.getElementById('attRoom').value;
  const subject = document.getElementById('attSubject').value;
  if(!date || !room || !subject || CURRENT_ATT.length===0){ Swal.fire('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö'); return; }
  const payload = encodeURIComponent(JSON.stringify({date,room,subject,rows:CURRENT_ATT}));
  await jsonp(`action=saveAttendance&data=${payload}`);
  Swal.fire('‚úÖ','‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à','success');
}

/* =========================
   Manage: Classes & Students
========================= */
function switchManageTab(name){
  document.getElementById('panel-classes').style.display = name==='classes' ? 'block':'none';
  document.getElementById('panel-subjects').style.display = name==='subjects' ? 'block':'none';
  document.getElementById('tab-classes').classList.toggle('active', name==='classes');
  document.getElementById('tab-subjects').classList.toggle('active', name==='subjects');
}

function addClass(){
  const name = document.getElementById('newClassName').value.trim();
  if(!name) return;
  if(ROOMS.find(r=>r.name===name)){ Swal.fire('‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠‡∏´‡πâ‡∏≠‡∏á‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡πâ‡∏ß'); return; }
  ROOMS.push({name});
  STUDENTS_BY_ROOM[name] = [];
  document.getElementById('newClassName').value='';
  renderClassCards(); fillSelects('attRoom','attSubject'); fillSelects('hisRoom','hisSubject');
}

function renderClassCards(){
  const wrap = document.getElementById('classCards');
  wrap.innerHTML = '';
  ROOMS.forEach(r=>{
    const count = (STUDENTS_BY_ROOM[r.name]||[]).length;
    const card = document.createElement('div');
    card.className = 'card';
    card.innerHTML = `
      <div class="row" style="justify-content:space-between">
        <div><b>${r.name}</b> <span class="badge">‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô (${count})</span></div>
        <div class="row">
          <button class="btn secondary" onclick="openManageStudents('${r.name}')">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</button>
          <button class="btn secondary" onclick="editClassName('${r.name}')">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
          <button class="btn warn" onclick="removeClass('${r.name}')">‡∏•‡∏ö</button>
        </div>
      </div>
    `;
    wrap.appendChild(card);
  });
}

function editClassName(oldName){
  Swal.fire({
    title:'‡πÅ‡∏Å‡πâ‡∏ä‡∏∑‡πà‡∏≠‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô', input:'text', inputValue:oldName, showCancelButton:true,
    confirmButtonText:'‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å'
  }).then(res=>{
    if(!res.isConfirmed) return;
    const newName = (res.value||'').trim(); if(!newName) return;
    if(ROOMS.find(r=>r.name===newName)){ Swal.fire('‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠‡∏´‡πâ‡∏≠‡∏á‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡πâ‡∏ß'); return; }
    // move
    const idx = ROOMS.findIndex(r=>r.name===oldName);
    ROOMS[idx].name = newName;
    STUDENTS_BY_ROOM[newName] = STUDENTS_BY_ROOM[oldName]||[];
    delete STUDENTS_BY_ROOM[oldName];
    renderClassCards(); fillSelects('attRoom','attSubject'); fillSelects('hisRoom','hisSubject');
  });
}

function removeClass(name){
  Swal.fire({title:`‡∏•‡∏ö "${name}" ?`, icon:'warning', showCancelButton:true}).then(r=>{
    if(!r.isConfirmed) return;
    ROOMS = ROOMS.filter(x=>x.name!==name);
    delete STUDENTS_BY_ROOM[name];
    renderClassCards(); fillSelects('attRoom','attSubject'); fillSelects('hisRoom','hisSubject');
  });
}

function openManageStudents(className){
  const list = (STUDENTS_BY_ROOM[className]||[]).slice().sort((a,b)=>Number(a.number)-Number(b.number));
  let html = `
    <div class="row" style="margin-bottom:10px">
      <input type="number" id="stuNo" placeholder="‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà" style="width:100px">
      <input type="text" id="stuId" placeholder="‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß (1-6 ‡∏´‡∏•‡∏±‡∏Å)" style="width:180px" />
      <input type="text" id="stuName" placeholder="‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•" style="min-width:240px" />
      <button class="btn" onclick="addStudent('${className}')">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
      <input type="file" id="fileExcel" accept=".xlsx,.xls" style="display:none"/>
      <button class="btn secondary" onclick="document.getElementById('fileExcel').click()">‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏à‡∏≤‡∏Å Excel</button>
      <span class="note">‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå A=‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà, B=‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß, C=‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•</span>
    </div>
    <div class="table-wrap"><table>
      <thead><tr><th style="width:90px">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà</th><th style="width:160px">‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß</th><th>‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•</th><th style="width:120px">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th></tr></thead>
      <tbody id="stuBody">
        ${list.map((s,i)=>`<tr><td>${s.number}</td><td>${s.id}</td><td>${s.name}</td>
          <td><button class="btn secondary" onclick="editStudent('${className}',${i})">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
              <button class="btn warn" onclick="deleteStudent('${className}',${i})">‡∏•‡∏ö</button></td></tr>`).join('')}
      </tbody>
    </table></div>
  `;
  Swal.fire({
    title:`‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏´‡πâ‡∏≠‡∏á ${className}`,
    width:900, html:html, showConfirmButton:false, showCloseButton:true, didOpen:()=>{
      const input = document.getElementById('fileExcel');
      input.onchange = (e)=>handleImportExcel(e,className);
    }
  });
}

function addStudent(className){
  const number = String(document.getElementById('stuNo').value||'').trim();
  const id = String(document.getElementById('stuId').value||'').trim();
  const name = String(document.getElementById('stuName').value||'').trim();
  if(!number || !id || !name){ Swal.fire('‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö'); return; }
  if(!/^\d{1,6}$/.test(id)){ Swal.fire('‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç 1‚Äì6 ‡∏´‡∏•‡∏±‡∏Å'); return; }
  (STUDENTS_BY_ROOM[className] ||= []).push({number,id,name});
  openManageStudents(className); renderClassCards();
}
function editStudent(className, idx){
  const s = (STUDENTS_BY_ROOM[className]||[])[idx];
  Swal.fire({
    title:'‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô', html:`
      <div class="row"><input id="eNo" type="number" value="${s.number}" style="width:120px">
      <input id="eId" type="text" value="${s.id}" style="width:180px">
      <input id="eName" type="text" value="${s.name}" style="min-width:240px"></div>`,
    showCancelButton:true, confirmButtonText:'‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å'
  }).then(r=>{
    if(!r.isConfirmed) return;
    const number = document.getElementById('eNo').value.trim();
    const id = document.getElementById('eId').value.trim();
    const name = document.getElementById('eName').value.trim();
    STUDENTS_BY_ROOM[className][idx] = {number,id,name};
    openManageStudents(className); renderClassCards();
  });
}
function deleteStudent(className, idx){
  (STUDENTS_BY_ROOM[className]||[]).splice(idx,1);
  openManageStudents(className); renderClassCards();
}

// Excel import (.xlsx) with preview
function handleImportExcel(ev, className){
  const file = ev.target.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = (e)=>{
    const wb = XLSX.read(new Uint8Array(e.target.result), {type:'array'});
    const ws = wb.Sheets[wb.SheetNames[0]];
    const json = XLSX.utils.sheet_to_json(ws, {header:1});
    // expect: A=‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà, B=‡∏£‡∏´‡∏±‡∏™, C=‡∏ä‡∏∑‡πà‡∏≠
    const rows = json.slice(1).filter(r=>r && (r[0]||r[1]||r[2])).map(r=>({
      number: String(r[0]||'').trim(),
      id: String(r[1]||'').trim(),
      name: String(r[2]||'').trim()
    })).filter(x=>x.number && x.id && x.name);
    const html = `
      <div class="preview-table"><table>
        <thead><tr><th>‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà</th><th>‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß</th><th>‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•</th></tr></thead>
        <tbody>${rows.map(r=>`<tr><td>${r.number}</td><td>${r.id}</td><td>${r.name}</td></tr>`).join('')}</tbody>
      </table></div>
    `;
    Swal.fire({
      title:'‡∏û‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤', html, showCancelButton:true, confirmButtonText:'‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•'
    }).then(res=>{
      if(!res.isConfirmed) return;
      (STUDENTS_BY_ROOM[className] ||= []).push(...rows);
      openManageStudents(className); renderClassCards();
      Swal.fire('‚úÖ','‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡πâ‡∏ß','success');
    });
  };
  reader.readAsArrayBuffer(file);
}

// Save / Delete to Google Sheets (classes + students)
async function saveAllClasses(){
  const data = encodeURIComponent(JSON.stringify({rooms:ROOMS, studentsByRoom:STUDENTS_BY_ROOM}));
  await jsonp(`action=saveClasses&data=${data}`);
  Swal.fire('‚úÖ','‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô/‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏•‡∏á Google Sheet ‡πÅ‡∏•‡πâ‡∏ß','success');
}
async function deleteAllClasses(){
  const ok = await Swal.fire({title:'‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?', icon:'warning', showCancelButton:true})
  if(!ok.isConfirmed) return;
  await jsonp(`action=deleteAllClasses`);
  ROOMS=[]; STUDENTS_BY_ROOM={}; renderClassCards(); fillSelects('attRoom','attSubject'); fillSelects('hisRoom','hisSubject');
  Swal.fire('‚úÖ','‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÅ‡∏•‡πâ‡∏ß','success');
}

/* =========================
   Manage: Subjects
========================= */
function addSubject(){
  const s = document.getElementById('newSubject').value.trim();
  if(!s) return;
  if(SUBJECTS.includes(s)){ Swal.fire('‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡πâ‡∏ß'); return; }
  SUBJECTS.push(s); document.getElementById('newSubject').value='';
  renderSubjectCards(); fillSelects('attRoom','attSubject'); fillSelects('hisRoom','hisSubject');
}
function renderSubjectCards(){
  const wrap = document.getElementById('subjectCards'); wrap.innerHTML='';
  SUBJECTS.forEach(name=>{
    const card = document.createElement('div');
    card.className='card';
    card.innerHTML = `
      <div class="row" style="justify-content:space-between">
        <div><b>${name}</b></div>
        <div class="row">
          <button class="btn secondary" onclick="editSubject('${name}')">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
          <button class="btn warn" onclick="removeSubject('${name}')">‡∏•‡∏ö</button>
        </div>
      </div>`;
    wrap.appendChild(card);
  });
}
function editSubject(oldName){
  Swal.fire({title:'‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤', input:'text', inputValue:oldName, showCancelButton:true})
    .then(r=>{
      if(!r.isConfirmed) return;
      const v = (r.value||'').trim(); if(!v) return;
      if(SUBJECTS.includes(v)){ Swal.fire('‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡πâ‡∏ß'); return; }
      SUBJECTS = SUBJECTS.map(x=>x===oldName? v : x);
      renderSubjectCards(); fillSelects('attRoom','attSubject'); fillSelects('hisRoom','hisSubject');
    });
}
function removeSubject(name){
  Swal.fire({title:`‡∏•‡∏ö "${name}" ?`, icon:'warning', showCancelButton:true})
    .then(r=>{
      if(!r.isConfirmed) return;
      SUBJECTS = SUBJECTS.filter(x=>x!==name);
      renderSubjectCards(); fillSelects('attRoom','attSubject'); fillSelects('hisRoom','hisSubject');
    });
}
async function saveAllSubjects(){
  const data = encodeURIComponent(JSON.stringify({subjects:SUBJECTS}));
  await jsonp(`action=saveSubjects&data=${data}`);
  Swal.fire('‚úÖ','‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤‡∏•‡∏á Google Sheet ‡πÅ‡∏•‡πâ‡∏ß','success');
}
async function deleteAllSubjects(){
  const ok = await Swal.fire({title:'‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?', icon:'warning', showCancelButton:true})
  if(!ok.isConfirmed) return;
  await jsonp(`action=deleteAllSubjects`);
  SUBJECTS=[]; renderSubjectCards(); fillSelects('attRoom','attSubject'); fillSelects('hisRoom','hisSubject');
  Swal.fire('‚úÖ','‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÅ‡∏•‡πâ‡∏ß','success');
}

/* =========================
   History + Report
========================= */
let chartInst = null;

async function loadHistory(){
  const date = document.getElementById('hisDate').value;
  const room = document.getElementById('hisRoom').value;
  const subject = document.getElementById('hisSubject').value;
  if(!date || !room || !subject){ Swal.fire('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô/‡∏´‡πâ‡∏≠‡∏á/‡∏ß‡∏¥‡∏ä‡∏≤'); return; }
  const payload = encodeURIComponent(JSON.stringify({date,room,subject}));
  const rows = await jsonp(`action=getHistory&data=${payload}`);
  // Fill table
  const tbody = document.getElementById('hisBody'); tbody.innerHTML='';
  rows.forEach(r=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${r.number}</td><td>${r.studentId}</td><td>${r.name}</td><td>${r.status}</td>`;
    tbody.appendChild(tr);
  });

  // Build report by student
  const byName = {};
  rows.forEach(r=>{
    byName[r.name] ||= {‡∏°‡∏≤:0,‡∏Ç‡∏≤‡∏î:0,‡∏™‡∏≤‡∏¢:0,‡∏•‡∏≤‡∏Å‡∏¥‡∏à:0,‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢:0,‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°:0};
    byName[r.name][r.status] = (byName[r.name][r.status]||0)+1;
  });
  const repArray = Object.entries(byName).map(([name, s])=>{
    const total = s.‡∏°‡∏≤+s.‡∏Ç‡∏≤‡∏î+s.‡∏™‡∏≤‡∏¢+s.‡∏•‡∏≤‡∏Å‡∏¥‡∏à+s.‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢+s.‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°;
    const pct = total? Math.round(s.‡∏°‡∏≤*100/total) : 0;
    return {name, ...s, percent:pct};
  });
  renderReport(repArray);
}

function renderReport(report){
  // KPIs
  const sum = (key)=> report.reduce((a,b)=>a+(b[key]||0),0);
  document.getElementById('kpi-present').textContent = sum('‡∏°‡∏≤');
  document.getElementById('kpi-absent').textContent = sum('‡∏Ç‡∏≤‡∏î');
  document.getElementById('kpi-late').textContent = sum('‡∏™‡∏≤‡∏¢');

  // Table
  const tbody = document.getElementById('repBody'); tbody.innerHTML='';
  report.forEach(r=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${r.name}</td>
      <td>${r.‡∏°‡∏≤}</td><td>${r.‡∏Ç‡∏≤‡∏î}</td><td>${r.‡∏™‡∏≤‡∏¢}</td><td>${r.‡∏•‡∏≤‡∏Å‡∏¥‡∏à}</td><td>${r.‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢}</td><td>${r.‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°}</td>
      <td>${r.percent}%</td>`;
    tbody.appendChild(tr);
  });

  // Chart
  const ctx = document.getElementById('repChart').getContext('2d');
  if(chartInst) chartInst.destroy();
  chartInst = new Chart(ctx, {
    type:'bar',
    data:{
      labels: report.map(r=>r.name),
      datasets:[
        {label:'‡∏°‡∏≤', data:report.map(r=>r.‡∏°‡∏≤), backgroundColor:'#27ae60'},
        {label:'‡∏Ç‡∏≤‡∏î', data:report.map(r=>r.‡∏Ç‡∏≤‡∏î), backgroundColor:'#c0392b'},
        {label:'‡∏™‡∏≤‡∏¢', data:report.map(r=>r.‡∏™‡∏≤‡∏¢), backgroundColor:'#f1c40f'},
        {label:'‡∏•‡∏≤‡∏Å‡∏¥‡∏à', data:report.map(r=>r.‡∏•‡∏≤‡∏Å‡∏¥‡∏à), backgroundColor:'#8e44ad'},
        {label:'‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢', data:report.map(r=>r.‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢), backgroundColor:'#e67e22'},
        {label:'‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°', data:report.map(r=>r.‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°), backgroundColor:'#f39c12'}
      ]
    },
    options:{responsive:true, scales:{y:{beginAtZero:true}}, plugins:{legend:{position:'top'}}}
  });
}

/* =========================
   Export
========================= */
function exportExcel(){
  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.table_to_sheet(document.getElementById('repTable'));
  XLSX.utils.book_append_sheet(wb, ws, 'Report');
  XLSX.writeFile(wb, 'Attendance_Report.xlsx');
}
function exportPDF(){
  const el = document.getElementById('repTable');
  html2pdf().set({margin:10, filename:'Attendance_Report.pdf', html2canvas:{scale:2}}).from(el).save();
}
</script>
</body>
</html>
