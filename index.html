/** ===== Utilities ===== */
function _ss(){ return SpreadsheetApp.getActiveSpreadsheet(); }
function _sh(name){ return _ss().getSheetByName(name) || _ss().insertSheet(name); }

function _toJSONP(callback, obj){
  var text = callback + '(' + JSON.stringify(obj) + ');';
  return ContentService.createTextOutput(text).setMimeType(ContentService.MimeType.JAVASCRIPT);
}
function _rows_(sheet){
  var v = sheet.getDataRange().getValues();
  return v;
}

/** ===== Router ===== */
function doGet(e){
  var action = e.parameter.action || '';
  var cb = e.parameter.callback || 'callback';
  try{
    if(action==='getAll') return _toJSONP(cb, getAll());
    if(action==='saveClasses') return _toJSONP(cb, saveClasses_(e));
    if(action==='deleteAllClasses') return _toJSONP(cb, deleteAllClasses_());
    if(action==='saveSubjects') return _toJSONP(cb, saveSubjects_(e));
    if(action==='deleteAllSubjects') return _toJSONP(cb, deleteAllSubjects_());
    if(action==='saveAttendance') return _toJSONP(cb, saveAttendance_(e));
    if(action==='getHistory') return _toJSONP(cb, getHistory_(e));
    return _toJSONP(cb, {error:'Unknown action'});
  }catch(err){
    return _toJSONP(cb, {error:String(err)});
  }
}

/** ===== Handlers ===== */
function getAll(){
  var rooms = _rows_(_sh('Rooms')).slice(1).map(function(r){ return {name: String(r[0]||'').trim()}; }).filter(function(r){ return r.name; });
  var subjects = _rows_(_sh('Subjects')).slice(1).map(function(r){ return String(r[0]||'').trim(); }).filter(String);
  var studentsRows = _rows_(_sh('Students')).slice(1);
  var studentsByRoom = {};
  studentsRows.forEach(function(r){
    var room = String(r[0]||'').trim();
    var number = String(r[1]||'').trim();
    var sid = String(r[2]||'').trim();
    var name = String(r[3]||'').trim();
    if(!room || !number || !sid || !name) return;
    (studentsByRoom[room] = studentsByRoom[room] || []).push({number:number, id:sid, name:name});
  });
  return {rooms:rooms, subjects:subjects, studentsByRoom:studentsByRoom};
}

function saveClasses_(e){
  var data = JSON.parse(e.parameter.data || '{}');
  var rooms = data.rooms || [];
  var sbr = data.studentsByRoom || {};
  var shR = _sh('Rooms'); shR.clear(); shR.getRange(1,1,1,1).setValues([['RoomName']]);
  if(rooms.length){
    shR.getRange(2,1,rooms.length,1).setValues(rooms.map(function(r){return [r.name];}));
  }
  var shS = _sh('Students'); shS.clear(); shS.getRange(1,1,1,4).setValues([['Room','Number','StudentId','Name']]);
  var rows = [];
  Object.keys(sbr).forEach(function(room){
    (sbr[room]||[]).forEach(function(s){
      rows.push([room, s.number, s.id, s.name]);
    });
  });
  if(rows.length) shS.getRange(2,1,rows.length,4).setValues(rows);
  return {success:true, message:'Saved classes & students'};
}

function deleteAllClasses_(){
  _sh('Rooms').clear();
  _sh('Students').clear();
  _sh('Rooms').getRange(1,1,1,1).setValues([['RoomName']]);
  _sh('Students').getRange(1,1,1,4).setValues([['Room','Number','StudentId','Name']]);
  return {success:true};
}

function saveSubjects_(e){
  var data = JSON.parse(e.parameter.data || '{}');
  var arr = data.subjects || [];
  var sh = _sh('Subjects'); sh.clear();
  sh.getRange(1,1,1,1).setValues([['SubjectName']]);
  if(arr.length) sh.getRange(2,1,arr.length,1).setValues(arr.map(function(s){return [s];}));
  return {success:true};
}

function deleteAllSubjects_(){
  var sh = _sh('Subjects'); sh.clear();
  sh.getRange(1,1,1,1).setValues([['SubjectName']]);
  return {success:true};
}

function saveAttendance_(e){
  var data = JSON.parse(e.parameter.data || '{}');
  var date = data.date, room = data.room, subject = data.subject;
  var rows = data.rows || [];
  var sh = _sh('Attendance');
  if(sh.getLastRow()===0){
    sh.getRange(1,1,1,7).setValues([['Date','Room','Subject','Number','StudentId','Name','Status']]);
  }
  var values = rows.map(function(r){
    return [date, room, subject, r.number, r.id, r.name, r.status];
  });
  if(values.length) sh.getRange(sh.getLastRow()+1, 1, values.length, 7).setValues(values);
  return {success:true, inserted: values.length};
}

function getHistory_(e){
  var data = JSON.parse(e.parameter.data || '{}');
  var date = data.date, room = data.room, subject = data.subject;
  var sh = _sh('Attendance');
  if(sh.getLastRow()===0) return [];
  var vals = _rows_(sh).slice(1).filter(function(r){
    var d = Utilities.formatDate(new Date(r[0]), Session.getScriptTimeZone(), 'yyyy-MM-dd');
    return d===date && String(r[1])===room && String(r[2])===subject;
  }).map(function(r){
    return {date:r[0], room:r[1], subject:r[2], number:r[3], studentId:r[4], name:r[5], status:r[6]};
  });
  return vals;
}
