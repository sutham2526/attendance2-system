<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบบันทึกการเข้าเรียน</title>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Sarabun', sans-serif;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .connection-status {
            display: inline-block;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
            margin-top: 10px;
        }

        .status-online {
            background: linear-gradient(135deg, #2ecc71, #27ae60);
            color: white;
        }

        .status-offline {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
        }

        .nav-tabs {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .nav-tab {
            padding: 15px 30px;
            border: none;
            border-radius: 15px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            color: white;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
            min-width: 200px;
        }

        .nav-tab.attendance {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }

        .nav-tab.manage {
            background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
        }

        .nav-tab.history {
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
        }

        .nav-tab.reports {
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
            color: #333;
            text-shadow: none;
        }

        .nav-tab:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }

        .nav-tab.active {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.5s ease-in;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .card {
            background: white;
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
            margin-bottom: 25px;
            border: 1px solid rgba(255,255,255,0.2);
        }

        .card-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .card-header i {
            font-size: 1.5rem;
            margin-right: 15px;
            padding: 10px;
            border-radius: 10px;
            color: white;
        }

        .card-header h3 {
            font-size: 1.4rem;
            font-weight: 600;
            color: #333;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
            font-size: 1.1rem;
        }

        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1.1rem;
            font-family: 'Sarabun', sans-serif;
            transition: all 0.3s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: #4facfe;
            box-shadow: 0 0 0 3px rgba(79, 172, 254, 0.1);
        }

        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Sarabun', sans-serif;
        }

        .btn-primary {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, #feca57 0%, #ff9ff3 100%);
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.2);
        }

        .student-list {
            max-height: 500px;
            overflow-y: auto;
        }

        .student-item {
            display: flex;
            align-items: center;
            padding: 10px;
            border: 2px solid #f0f0f0;
            border-radius: 12px;
            margin-bottom: 8px;
            background: #fafafa;
            transition: all 0.3s ease;
        }

        .student-item:hover {
            background: #f0f8ff;
            border-color: #4facfe;
        }

        .student-info {
            flex: 1;
            display: grid;
            grid-template-columns: 60px 120px 1fr;
            gap: 15px;
            align-items: center;
        }

        .student-no {
            font-weight: 600;
            color: #666;
            text-align: center;
        }

        .student-id {
            font-weight: 600;
            color: #333;
        }

        .student-name {
            font-weight: 500;
            color: #333;
        }

        .status-buttons {
            display: flex;
            gap: 8px;
        }

        .status-btn {
            width: 32px;
            height: 32px;
            border: none;
            border-radius: 50%;
            font-weight: 700;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.3s ease;
            color: black;
            text-shadow: none;
        }

        .status-btn.present {
            background: linear-gradient(135deg, #2ecc71, #27ae60);
        }

        .status-btn.absent {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
        }

        .status-btn.leave {
            background: linear-gradient(135deg, #9b59b6, #8e44ad);
        }

        .status-btn.sick {
            background: linear-gradient(135deg, #3498db, #2980b9);
        }

        .status-btn.activity {
            background: linear-gradient(135deg, #f39c12, #e67e22);
        }

        .status-btn:not(.active) {
            opacity: 0.3;
            transform: scale(0.9);
        }

        .status-btn.active {
            transform: scale(1.1);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
        }

        .grid-3 {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
        }

        .stats-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            text-align: center;
            padding: 20px;
            border-radius: 15px;
        }

        .stats-number {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .stats-label {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .table th,
        .table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        .table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #333;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .file-input-wrapper {
            position: relative;
            display: inline-block;
            cursor: pointer;
            width: 100%;
        }

        .file-input {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        .file-input-display {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            border: 2px dashed #4facfe;
            border-radius: 10px;
            background: #f8f9ff;
            color: #4facfe;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .file-input-display:hover {
            background: #e6f3ff;
            border-color: #0066cc;
        }

        .chart-container {
            position: relative;
            height: 300px;
            margin: 20px 0;
        }

        @media (max-width: 768px) {
            .grid-2 {
                grid-template-columns: 1fr;
            }
            
            .student-info {
                grid-template-columns: 50px 100px 1fr;
                gap: 10px;
            }
            
            .status-buttons {
                gap: 5px;
            }
            
            .status-btn {
                width: 35px;
                height: 35px;
                font-size: 0.9rem;
            }
            
            .nav-tabs {
                flex-direction: column;
                align-items: center;
            }
            
            .nav-tab {
                min-width: 250px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-graduation-cap"></i> ระบบบันทึกการเข้าเรียน</h1>
            <p>Student Attendance Management System</p>
            <div id="connectionStatus" class="connection-status status-offline">
                <i class="fas fa-wifi"></i> กำลังเชื่อมต่อ...
            </div>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab attendance active" onclick="showTab('attendance')">
                <i class="fas fa-user-check"></i> บันทึกการเข้าเรียน
            </button>
            <button class="nav-tab manage" onclick="showTab('manage')">
                <i class="fas fa-cogs"></i> จัดการข้อมูล
            </button>
            <button class="nav-tab history" onclick="showTab('history')">
                <i class="fas fa-history"></i> ประวัติการเข้าเรียน
            </button>
            <button class="nav-tab reports" onclick="showTab('reports')">
                <i class="fas fa-chart-bar"></i> รายงานสรุปผล
            </button>
        </div>

        <!-- บันทึกการเข้าเรียน -->
        <div id="attendance" class="tab-content active">
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-calendar-check" style="background: linear-gradient(135deg, #4facfe, #00f2fe);"></i>
                    <h3>บันทึกการเข้าเรียน</h3>
                </div>
                
                <div class="grid-3">
                    <div class="form-group">
                        <label class="form-label">วันที่</label>
                        <input type="date" id="attendanceDate" class="form-control" onchange="resetAttendanceData()">
                    </div>
                    <div class="form-group">
                        <label class="form-label">ห้องเรียน</label>
                        <select id="attendanceClass" class="form-control" onchange="checkLoadConditions()">
                            <option value="">เลือกห้องเรียน</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">รายวิชา</label>
                        <select id="attendanceSubject" class="form-control" onchange="checkLoadConditions()">
                            <option value="">เลือกรายวิชา</option>
                        </select>
                    </div>
                </div>

                <div id="studentsList" class="student-list" style="display: none;">
                    <h4 style="margin-bottom: 20px; color: #333;">รายชื่อนักเรียน</h4>
                    <div id="studentsContainer"></div>
                    <button class="btn btn-success" onclick="saveAttendance()" style="width: 100%; margin-top: 20px; font-size: 1.2rem;">
                        <i class="fas fa-save"></i> บันทึกการเข้าเรียน
                    </button>
                </div>
            </div>
        </div>

        <!-- จัดการข้อมูล -->
        <div id="manage" class="tab-content">
            <div class="grid-2">
                <!-- จัดการห้องเรียน -->
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-school" style="background: linear-gradient(135deg, #43e97b, #38f9d7);"></i>
                        <h3>จัดการห้องเรียน</h3>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">ชื่อห้องเรียน</label>
                        <input type="text" id="newClassName" class="form-control" placeholder="เช่น ม.1/1">
                    </div>
                    <button class="btn btn-success" onclick="addClass()" style="width: 100%; margin-bottom: 20px;">
                        <i class="fas fa-plus"></i> เพิ่มห้องเรียน
                    </button>

                    <div id="classListContainer">
                        <h4 style="margin-bottom: 15px;">รายการห้องเรียน</h4>
                        <div id="classList"></div>
                    </div>
                </div>

                <!-- จัดการรายวิชา -->
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-book" style="background: linear-gradient(135deg, #fa709a, #fee140);"></i>
                        <h3>จัดการรายวิชา</h3>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">ชื่อรายวิชา</label>
                        <input type="text" id="newSubjectName" class="form-control" placeholder="เช่น คณิตศาสตร์">
                    </div>
                    <button class="btn btn-success" onclick="addSubject()" style="width: 100%; margin-bottom: 20px;">
                        <i class="fas fa-plus"></i> เพิ่มรายวิชา
                    </button>

                    <div id="subjectListContainer">
                        <h4 style="margin-bottom: 15px;">รายการวิชา</h4>
                        <div id="subjectList"></div>
                    </div>
                </div>
            </div>

            <!-- จัดการนักเรียน -->
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-users" style="background: linear-gradient(135deg, #a8edea, #fed6e3);"></i>
                    <h3>จัดการนักเรียน</h3>
                </div>

                <div class="grid-2" style="margin-bottom: 20px;">
                    <div>
                        <label class="form-label">เลือกห้องเรียน</label>
                        <select id="studentClassSelect" class="form-control" onchange="loadStudents()">
                            <option value="">เลือกห้องเรียน</option>
                        </select>
                    </div>
                    <div>
                        <label class="form-label">นำเข้าจาก Excel</label>
                        <div class="file-input-wrapper">
                            <input type="file" id="excelFile" class="file-input" accept=".xlsx,.xls" onchange="importFromExcel()">
                            <div class="file-input-display">
                                <i class="fas fa-file-excel" style="margin-right: 10px;"></i>
                                เลือกไฟล์ Excel
                            </div>
                        </div>
                        <button id="saveExcelDataBtn" class="btn btn-success" onclick="saveExcelDataToServer()" style="width: 100%; margin-top: 10px; display: none;">
                            <i class="fas fa-cloud-upload-alt"></i> บันทึกข้อมูลลง Google Sheets
                        </button>
                    </div>
                </div>

                <div class="grid-3" style="margin-bottom: 20px;">
                    <div class="form-group">
                        <label class="form-label">เลขที่</label>
                        <input type="number" id="newStudentNo" class="form-control" placeholder="1">
                    </div>
                    <div class="form-group">
                        <label class="form-label">เลขประจำตัว</label>
                        <input type="text" id="newStudentId" class="form-control" placeholder="123456">
                    </div>
                    <div class="form-group">
                        <label class="form-label">ชื่อ-สกุล</label>
                        <input type="text" id="newStudentName" class="form-control" placeholder="นายสมชาย ใจดี">
                    </div>
                </div>

                <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                    <button class="btn btn-success" onclick="addStudent()" style="flex: 1;">
                        <i class="fas fa-user-plus"></i> เพิ่มนักเรียน
                    </button>
                    <button class="btn btn-danger" onclick="clearAllStudents()" style="flex: 1;">
                        <i class="fas fa-trash"></i> ลบข้อมูลทั้งหมด
                    </button>
                </div>

                <div id="studentListContainer">
                    <h4 style="margin-bottom: 15px;">รายชื่อนักเรียน</h4>
                    <div id="studentManageList"></div>
                </div>
            </div>
        </div>

        <!-- ประวัติการเข้าเรียน -->
        <div id="history" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-search" style="background: linear-gradient(135deg, #fa709a, #fee140);"></i>
                    <h3>ประวัติการเข้าเรียน</h3>
                </div>
                
                <div class="grid-3">
                    <div class="form-group">
                        <label class="form-label">วันที่</label>
                        <input type="date" id="historyDate" class="form-control" onchange="checkHistoryConditions()">
                    </div>
                    <div class="form-group">
                        <label class="form-label">ห้องเรียน</label>
                        <select id="historyClass" class="form-control" onchange="checkHistoryConditions()">
                            <option value="">เลือกห้องเรียน</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">รายวิชา</label>
                        <select id="historySubject" class="form-control" onchange="checkHistoryConditions()">
                            <option value="">เลือกรายวิชา</option>
                        </select>
                    </div>
                </div>

                <div id="historyResults"></div>
            </div>
        </div>

        <!-- รายงานสรุปผล -->
        <div id="reports" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-chart-pie" style="background: linear-gradient(135deg, #a8edea, #fed6e3);"></i>
                    <h3>รายงานสรุปผล</h3>
                </div>

                <div class="grid-3" style="margin-bottom: 20px;">
                    <div class="form-group">
                        <label class="form-label">วันที่เริ่มต้น</label>
                        <input type="date" id="reportStartDate" class="form-control" onchange="checkReportConditions()">
                    </div>
                    <div class="form-group">
                        <label class="form-label">วันที่สิ้นสุด</label>
                        <input type="date" id="reportEndDate" class="form-control" onchange="checkReportConditions()">
                    </div>
                    <div class="form-group">
                        <label class="form-label">ห้องเรียน</label>
                        <select id="reportClass" class="form-control" onchange="checkReportConditions()">
                            <option value="">เลือกห้องเรียน</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">รายวิชา</label>
                        <select id="reportSubject" class="form-control" onchange="checkReportConditions()">
                            <option value="">เลือกรายวิชา</option>
                        </select>
                    </div>
                </div>

                <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                    <button class="btn btn-danger" onclick="generatePDFReport()" style="width: 100%;">
                        <i class="fas fa-file-pdf"></i> สร้างรายงาน PDF
                    </button>
                </div>

                <div id="reportResults">
                    <div class="grid-2">
                        <div>
                            <h4>สถิติการเข้าเรียน</h4>
                            <div id="statsContainer" class="grid-3"></div>
                        </div>
                        <div>
                            <h4>กราฟสรุปผล</h4>
                            <div class="chart-container">
                                <canvas id="attendanceChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal สำหรับแก้ไขข้อมูล -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <h3 id="modalTitle">แก้ไขข้อมูล</h3>
            <div id="modalBody"></div>
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="btn btn-success" onclick="saveEdit()" style="flex: 1;">บันทึก</button>
                <button class="btn btn-danger" onclick="closeModal()" style="flex: 1;">ยกเลิก</button>
            </div>
        </div>
    </div>

    <script>
        // ข้อมูลระบบ
        let systemData = {
            classes: [],
            subjects: [],
            students: {},
            attendance: []
        };

        let currentEdit = null;
        let attendanceChart = null;
        let isOnline = false;
        let tempExcelData = null; // เก็บข้อมูลจาก Excel ชั่วคราว

        // URL Google Apps Script
        const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbwx_l9dnBVP5daaTfxyP8QYdOkClRBdwvUvN9-o51-uI9OGUNl2t6xf3u3I9xPK9p0/exec';
        const SHEET_ID = '1ski-KWzrzsnWKkdlbJ0sPdwtNWZR5No809eK-Bk91t4';

        // เริ่มต้นระบบ
        document.addEventListener('DOMContentLoaded', function() {
            initializeSystem();
        });

        function initializeSystem() {
            // ตั้งค่าวันที่เป็นวันปัจจุบัน
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('attendanceDate').value = today;
            // ไม่จำกัดวันที่สูงสุด เพื่อให้สามารถเลือกวันที่ในอนาคตได้
            
            // โหลดข้อมูลเริ่มต้น
            loadInitialData();
        }

        async function loadInitialData() {
            try {
                updateConnectionStatus(false, 'กำลังเชื่อมต่อ...');
                
                // เชื่อมต่อ Google Sheets
                const response = await sendToGoogleSheets({ action: 'loadData' });
                
                if (response && response.success) {
                    systemData.classes = response.data.classes || [];
                    systemData.subjects = response.data.subjects || [];
                    systemData.students = response.data.students || {};
                    systemData.attendance = response.data.attendance || [];
                    
                    updateConnectionStatus(true);
                    console.log('Successfully connected to Google Sheets');
                    console.log('Loaded data:', systemData);
                } else {
                    throw new Error('Invalid response from Google Sheets');
                }
            } catch (error) {
                console.error('Connection failed:', error.message);
                updateConnectionStatus(false, 'ไม่สามารถเชื่อมต่อได้');
                
                Swal.fire({
                    title: 'ไม่สามารถเชื่อมต่อ Google Sheets',
                    html: `
                        <p><strong>กรุณาตรวจสอบ:</strong></p>
                        <ul style="text-align: left; margin: 10px 0;">
                            <li>Google Apps Script ได้ Deploy แล้วหรือยัง</li>
                            <li>URL ของ Google Apps Script ถูกต้องหรือไม่</li>
                            <li>Google Sheets มีสิทธิ์เข้าถึงหรือไม่</li>
                            <li>การเชื่อมต่ออินเทอร์เน็ตปกติหรือไม่</li>
                        </ul>
                        <p><strong>ระบบต้องการการเชื่อมต่อ Google Sheets เพื่อทำงาน</strong></p>
                    `,
                    icon: 'error',
                    confirmButtonText: 'ลองเชื่อมต่อใหม่',
                    allowOutsideClick: false
                }).then(() => {
                    location.reload();
                });
                return;
            }

            updateAllSelects();
            loadStudents();
            displayClasses();
            displaySubjects();
        }



        function updateConnectionStatus(online, message = null) {
            isOnline = online;
            const statusElement = document.getElementById('connectionStatus');
            
            if (online) {
                statusElement.className = 'connection-status status-online';
                statusElement.innerHTML = '<i class="fas fa-wifi"></i> เชื่อมต่อ Google Sheets';
                statusElement.title = 'ข้อมูลถูกบันทึกใน Google Sheets';
            } else {
                statusElement.className = 'connection-status status-offline';
                statusElement.innerHTML = `<i class="fas fa-wifi-slash"></i> ${message || 'ไม่สามารถเชื่อมต่อได้'}`;
                statusElement.title = 'กรุณาตรวจสอบการเชื่อมต่ออินเทอร์เน็ต';
            }
        }

        // ฟังก์ชันส่งข้อมูลไป Google Sheets
        async function sendToGoogleSheets(data) {
            try {
                // แสดงการโหลด (ยกเว้นการโหลดข้อมูลเริ่มต้น)
                if (data.action !== 'loadData') {
                    Swal.fire({
                        title: 'กำลังบันทึกข้อมูล',
                        text: 'กรุณารอสักครู่...',
                        allowOutsideClick: false,
                        didOpen: () => {
                            Swal.showLoading();
                        }
                    });
                }

                console.log('Sending data to Google Sheets:', data);

                // ใช้ JSONP เป็นหลัก เพราะ Google Apps Script รองรับดีกว่า
                return new Promise((resolve, reject) => {
                    const callbackName = 'jsonp_callback_' + Math.round(100000 * Math.random());
                    
                    window[callbackName] = function(result) {
                        console.log('Received response via JSONP:', result);
                        delete window[callbackName];
                        if (document.body.contains(script)) {
                            document.body.removeChild(script);
                        }
                        if (data.action !== 'loadData') {
                            Swal.close();
                        }
                        resolve(result);
                    };

                    const script = document.createElement('script');
                    const encodedData = encodeURIComponent(JSON.stringify(data));
                    script.src = `${WEB_APP_URL}?callback=${callbackName}&data=${encodedData}`;
                    
                    script.onerror = function() {
                        console.error('JSONP script error - อาจเป็นปัญหาจาก Google Apps Script');
                        delete window[callbackName];
                        if (document.body.contains(script)) {
                            document.body.removeChild(script);
                        }
                        if (data.action !== 'loadData') {
                            Swal.close();
                        }
                        reject(new Error('Google Apps Script connection failed'));
                    };

                    document.body.appendChild(script);
                    
                    // Timeout หลัง 30 วินาที
                    setTimeout(() => {
                        if (window[callbackName]) {
                            console.log('JSONP timeout - Google Apps Script ไม่ตอบสนอง');
                            delete window[callbackName];
                            if (document.body.contains(script)) {
                                document.body.removeChild(script);
                            }
                            if (data.action !== 'loadData') {
                                Swal.close();
                            }
                            reject(new Error('Google Apps Script timeout'));
                        }
                    }, 30000);
                });
                
            } catch (error) {
                console.error('Error sending to Google Sheets:', error);
                
                if (data.action !== 'loadData') {
                    Swal.close();
                }
                
                throw error;
            }
        }

        // ฟังก์ชันแสดงแท็บ
        function showTab(tabName) {
            // ซ่อนแท็บทั้งหมด
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // ลบ active จากปุ่มทั้งหมด
            document.querySelectorAll('.nav-tab').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // รีเซ็ตข้อมูลตามเมนูที่เลือก
            resetTabData(tabName);
            
            // แสดงแท็บที่เลือก
            document.getElementById(tabName).classList.add('active');
            document.querySelector(`.nav-tab.${tabName}`).classList.add('active');
        }

        // ฟังก์ชันรีเซ็ตข้อมูลในแต่ละแท็บ
        function resetTabData(tabName) {
            switch(tabName) {
                case 'attendance':
                    // รีเซ็ตวันที่เป็นวันปัจจุบัน
                    const today = new Date().toISOString().split('T')[0];
                    document.getElementById('attendanceDate').value = today;
                    document.getElementById('attendanceClass').value = '';
                    document.getElementById('attendanceSubject').value = '';
                    document.getElementById('studentsList').style.display = 'none';
                    break;
                    
                case 'history':
                    // รีเซ็ตฟอร์มค้นหา
                    document.getElementById('historyDate').value = '';
                    document.getElementById('historyClass').value = '';
                    document.getElementById('historySubject').value = '';
                    document.getElementById('historyResults').innerHTML = '';
                    break;
                    
                case 'reports':
                    // รีเซ็ตฟอร์มรายงาน
                    document.getElementById('reportStartDate').value = '';
                    document.getElementById('reportEndDate').value = '';
                    document.getElementById('reportClass').value = '';
                    document.getElementById('reportSubject').value = '';
                    
                    // รีเซ็ตผลลัพธ์
                    document.getElementById('statsContainer').innerHTML = '';
                    if (attendanceChart) {
                        attendanceChart.destroy();
                        attendanceChart = null;
                    }
                    break;
            }
        }

        // ฟังก์ชันอัพเดทตัวเลือกทั้งหมด
        function updateAllSelects() {
            updateClassSelects();
            updateSubjectSelects();
        }

        function updateClassSelects() {
            const selects = ['attendanceClass', 'historyClass', 'reportClass', 'studentClassSelect'];
            selects.forEach(selectId => {
                const select = document.getElementById(selectId);
                const currentValue = select.value;
                select.innerHTML = '<option value="">เลือกห้องเรียน</option>';
                
                // เรียงลำดับห้องเรียนจากน้อยไปมาก
                const sortedClasses = [...systemData.classes].sort((a, b) => {
                    // แยกตัวเลขและตัวอักษรเพื่อเรียงลำดับที่ถูกต้อง
                    const aMatch = a.name.match(/(\d+)/);
                    const bMatch = b.name.match(/(\d+)/);
                    
                    if (aMatch && bMatch) {
                        const aNum = parseInt(aMatch[1]);
                        const bNum = parseInt(bMatch[1]);
                        if (aNum !== bNum) return aNum - bNum;
                    }
                    
                    return a.name.localeCompare(b.name, 'th');
                });
                
                sortedClasses.forEach(cls => {
                    const option = document.createElement('option');
                    option.value = cls.id;
                    option.textContent = cls.name;
                    select.appendChild(option);
                });
                
                select.value = currentValue;
            });
        }

        function updateSubjectSelects() {
            const selects = ['attendanceSubject', 'historySubject', 'reportSubject'];
            selects.forEach(selectId => {
                const select = document.getElementById(selectId);
                const currentValue = select.value;
                select.innerHTML = '<option value="">เลือกรายวิชา</option>';
                
                // เรียงลำดับรายวิชาจากน้อยไปมาก
                const sortedSubjects = [...systemData.subjects].sort((a, b) => {
                    // แยกตัวเลขและตัวอักษรเพื่อเรียงลำดับที่ถูกต้อง
                    const aMatch = a.name.match(/(\d+)/);
                    const bMatch = b.name.match(/(\d+)/);
                    
                    if (aMatch && bMatch) {
                        const aNum = parseInt(aMatch[1]);
                        const bNum = parseInt(bMatch[1]);
                        if (aNum !== bNum) return aNum - bNum;
                    }
                    
                    return a.name.localeCompare(b.name, 'th');
                });
                
                sortedSubjects.forEach(subject => {
                    const option = document.createElement('option');
                    option.value = subject.id;
                    option.textContent = subject.name;
                    select.appendChild(option);
                });
                
                select.value = currentValue;
            });
        }

        // ฟังก์ชันรีเซ็ตข้อมูลเมื่อเปลี่ยนวันที่
        function resetAttendanceData() {
            document.getElementById('attendanceClass').value = '';
            document.getElementById('attendanceSubject').value = '';
            document.getElementById('studentsList').style.display = 'none';
        }

        // ฟังก์ชันตรวจสอบเงื่อนไขการโหลด
        function checkLoadConditions() {
            const date = document.getElementById('attendanceDate').value;
            const classId = document.getElementById('attendanceClass').value;
            const subjectId = document.getElementById('attendanceSubject').value;
            
            if (date && classId && subjectId) {
                loadStudentsForAttendance(classId);
            } else {
                document.getElementById('studentsList').style.display = 'none';
            }
        }

        // ฟังก์ชันตรวจสอบเงื่อนไขประวัติการเข้าเรียน
        function checkHistoryConditions() {
            const date = document.getElementById('historyDate').value;
            const classId = document.getElementById('historyClass').value;
            const subjectId = document.getElementById('historySubject').value;
            
            if (date && classId && subjectId) {
                searchHistory();
            } else {
                document.getElementById('historyResults').innerHTML = '';
            }
        }

        // ฟังก์ชันตรวจสอบเงื่อนไขรายงาน
        function checkReportConditions() {
            const startDate = document.getElementById('reportStartDate').value;
            const endDate = document.getElementById('reportEndDate').value;
            const classId = document.getElementById('reportClass').value;
            const subjectId = document.getElementById('reportSubject').value;
            
            if (startDate && endDate && classId && subjectId) {
                generateReport();
            } else {
                // รีเซ็ตผลลัพธ์
                document.getElementById('statsContainer').innerHTML = '';
                if (attendanceChart) {
                    attendanceChart.destroy();
                    attendanceChart = null;
                }
            }
        }

        // ฟังก์ชันโหลดนักเรียนสำหรับเช็คชื่อ
        function loadStudentsForAttendance(classId) {
            const students = systemData.students[classId] || [];
            const container = document.getElementById('studentsContainer');
            
            if (students.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666;">ไม่พบนักเรียนในห้องเรียนนี้</p>';
                document.getElementById('studentsList').style.display = 'block';
                return;
            }
            
            container.innerHTML = students.map(student => `
                <div class="student-item">
                    <div class="student-info">
                        <div class="student-no">${student.no}</div>
                        <div class="student-id">${student.id}</div>
                        <div class="student-name">${student.name}</div>
                    </div>
                    <div class="status-buttons">
                        <button class="status-btn present active" onclick="setStatus(${student.no}, 'present', this)" title="มาเรียน">
                            /
                        </button>
                        <button class="status-btn absent" onclick="setStatus(${student.no}, 'absent', this)" title="ขาดเรียน">
                            ข
                        </button>
                        <button class="status-btn leave" onclick="setStatus(${student.no}, 'leave', this)" title="ลากิจ">
                            ล
                        </button>
                        <button class="status-btn sick" onclick="setStatus(${student.no}, 'sick', this)" title="ลาป่วย">
                            ป
                        </button>
                        <button class="status-btn activity" onclick="setStatus(${student.no}, 'activity', this)" title="กิจกรรม">
                            ก
                        </button>
                    </div>
                </div>
            `).join('');
            
            document.getElementById('studentsList').style.display = 'block';
        }

        // ฟังก์ชันตั้งสถานะ
        function setStatus(studentNo, status, button) {
            const studentItem = button.closest('.student-item');
            const buttons = studentItem.querySelectorAll('.status-btn');
            
            buttons.forEach(btn => btn.classList.remove('active'));
            button.classList.add('active');
            
            // เก็บสถานะ
            button.closest('.student-item').dataset.status = status;
        }

        // ฟังก์ชันบันทึกการเข้าเรียน
        async function saveAttendance() {
            const date = document.getElementById('attendanceDate').value;
            const classId = document.getElementById('attendanceClass').value;
            const subjectId = document.getElementById('attendanceSubject').value;
            
            if (!date || !classId || !subjectId) {
                Swal.fire('ข้อผิดพลาด', 'กรุณาเลือกข้อมูลให้ครบถ้วน', 'error');
                return;
            }
            
            // รวบรวมข้อมูลการเข้าเรียน
            const attendanceData = [];
            const studentItems = document.querySelectorAll('.student-item');
            
            studentItems.forEach(item => {
                const studentInfo = item.querySelector('.student-info');
                const no = studentInfo.querySelector('.student-no').textContent;
                const id = studentInfo.querySelector('.student-id').textContent;
                const name = studentInfo.querySelector('.student-name').textContent;
                const status = item.dataset.status || 'present';
                
                attendanceData.push({
                    no: no,
                    studentId: id,
                    name: name,
                    status: status
                });
            });
            
            try {
                const response = await sendToGoogleSheets({
                    action: 'saveAttendance',
                    date: date,
                    classId: classId,
                    subjectId: subjectId,
                    attendance: attendanceData
                });
                
                if (response && response.success) {
                    Swal.fire('สำเร็จ', 'บันทึกการเข้าเรียนเรียบร้อยแล้ว', 'success');
                } else {
                    throw new Error('Failed to save attendance');
                }
                
            } catch (error) {
                console.error('Error saving attendance:', error);
                Swal.fire('ข้อผิดพลาด', 'ไม่สามารถบันทึกข้อมูลได้ กรุณาตรวจสอบการเชื่อมต่อ', 'error');
            }
        }

        // ฟังก์ชันจัดการห้องเรียน
        async function addClass() {
            const name = document.getElementById('newClassName').value.trim();
            if (!name) {
                Swal.fire('ข้อผิดพลาด', 'กรุณาใส่ชื่อห้องเรียน', 'error');
                return;
            }
            
            const id = Date.now();
            const newClass = { id, name };
            
            try {
                const response = await sendToGoogleSheets({
                    action: 'addClass',
                    class: newClass
                });
                
                if (response && response.success) {
                    systemData.classes.push(newClass);
                    systemData.students[id] = [];
                    
                    document.getElementById('newClassName').value = '';
                    updateAllSelects();
                    displayClasses();
                    
                    Swal.fire('สำเร็จ', 'เพิ่มห้องเรียนเรียบร้อยแล้ว', 'success');
                } else {
                    throw new Error('Failed to add class');
                }
                
            } catch (error) {
                console.error('Error adding class:', error);
                Swal.fire('ข้อผิดพลาด', 'ไม่สามารถเพิ่มห้องเรียนได้ กรุณาลองใหม่', 'error');
            }
        }

        function displayClasses() {
            const container = document.getElementById('classList');
            const sortedClasses = [...systemData.classes].sort((a, b) => a.name.localeCompare(b.name, 'th'));
            
            container.innerHTML = sortedClasses.map(cls => {
                const studentCount = systemData.students[cls.id] ? systemData.students[cls.id].length : 0;
                return `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 8px;">
                        <span>${cls.name} (${studentCount} คน)</span>
                        <div>
                            <button class="btn btn-warning" onclick="editClass(${cls.id})" style="margin-right: 5px; padding: 5px 10px;">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-danger" onclick="deleteClass(${cls.id})" style="padding: 5px 10px;">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function editClass(id) {
            const cls = systemData.classes.find(c => c.id === id);
            if (!cls) return;
            
            currentEdit = { type: 'class', id };
            document.getElementById('modalTitle').textContent = 'แก้ไขห้องเรียน';
            document.getElementById('modalBody').innerHTML = `
                <div class="form-group">
                    <label class="form-label">ชื่อห้องเรียน</label>
                    <input type="text" id="editInput" class="form-control" value="${cls.name}">
                </div>
            `;
            document.getElementById('editModal').classList.add('show');
        }

        function deleteClass(id) {
            Swal.fire({
                title: 'ยืนยันการลบ',
                text: 'คุณต้องการลบห้องเรียนนี้หรือไม่?',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'ลบ',
                cancelButtonText: 'ยกเลิก'
            }).then((result) => {
                if (result.isConfirmed) {
                    deleteClassFromServer(id);
                }
            });
        }

        async function deleteClassFromServer(id) {
            try {
                const response = await sendToGoogleSheets({
                    action: 'deleteClass',
                    classId: id
                });
                
                if (response && response.success) {
                    systemData.classes = systemData.classes.filter(c => c.id !== id);
                    delete systemData.students[id];
                    
                    updateAllSelects();
                    displayClasses();
                    Swal.fire('สำเร็จ', 'ลบห้องเรียนเรียบร้อยแล้ว', 'success');
                } else {
                    throw new Error('Failed to delete class');
                }
            } catch (error) {
                console.error('Error deleting class:', error);
                Swal.fire('ข้อผิดพลาด', 'ไม่สามารถลบห้องเรียนได้ กรุณาลองใหม่', 'error');
            }
        }

        // ฟังก์ชันจัดการรายวิชา
        async function addSubject() {
            const name = document.getElementById('newSubjectName').value.trim();
            if (!name) {
                Swal.fire('ข้อผิดพลาด', 'กรุณาใส่ชื่อรายวิชา', 'error');
                return;
            }
            
            const id = Date.now();
            const newSubject = { id, name };
            
            try {
                const response = await sendToGoogleSheets({
                    action: 'addSubject',
                    subject: newSubject
                });
                
                if (response && response.success) {
                    systemData.subjects.push(newSubject);
                    
                    document.getElementById('newSubjectName').value = '';
                    updateAllSelects();
                    displaySubjects();
                    
                    Swal.fire('สำเร็จ', 'เพิ่มรายวิชาเรียบร้อยแล้ว', 'success');
                } else {
                    throw new Error('Failed to add subject');
                }
                
            } catch (error) {
                console.error('Error adding subject:', error);
                Swal.fire('ข้อผิดพลาด', 'ไม่สามารถเพิ่มรายวิชาได้ กรุณาลองใหม่', 'error');
            }
        }

        function displaySubjects() {
            const container = document.getElementById('subjectList');
            const sortedSubjects = [...systemData.subjects].sort((a, b) => a.name.localeCompare(b.name, 'th'));
            
            container.innerHTML = sortedSubjects.map(subject => `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 8px;">
                    <span>${subject.name}</span>
                    <div>
                        <button class="btn btn-warning" onclick="editSubject(${subject.id})" style="margin-right: 5px; padding: 5px 10px;">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-danger" onclick="deleteSubject(${subject.id})" style="padding: 5px 10px;">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function editSubject(id) {
            const subject = systemData.subjects.find(s => s.id === id);
            if (!subject) return;
            
            currentEdit = { type: 'subject', id };
            document.getElementById('modalTitle').textContent = 'แก้ไขรายวิชา';
            document.getElementById('modalBody').innerHTML = `
                <div class="form-group">
                    <label class="form-label">ชื่อรายวิชา</label>
                    <input type="text" id="editInput" class="form-control" value="${subject.name}">
                </div>
            `;
            document.getElementById('editModal').classList.add('show');
        }

        function deleteSubject(id) {
            Swal.fire({
                title: 'ยืนยันการลบ',
                text: 'คุณต้องการลบรายวิชานี้หรือไม่?',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'ลบ',
                cancelButtonText: 'ยกเลิก'
            }).then((result) => {
                if (result.isConfirmed) {
                    systemData.subjects = systemData.subjects.filter(s => s.id !== id);
                    updateAllSelects();
                    displaySubjects();
                    Swal.fire('สำเร็จ', 'ลบรายวิชาเรียบร้อยแล้ว', 'success');
                }
            });
        }

        // ฟังก์ชันเรียงลำดับนักเรียนใหม่
        function reorderStudents(classId) {
            if (!systemData.students[classId]) return;
            
            const students = systemData.students[classId];
            
            // แยกชายหญิง
            const maleStudents = students.filter(student => 
                student.name.startsWith('นาย') || 
                student.name.startsWith('เด็กชาย') || 
                student.name.startsWith('ด.ช.')
            );
            
            const femaleStudents = students.filter(student => 
                student.name.startsWith('นางสาว') || 
                student.name.startsWith('นาง') || 
                student.name.startsWith('เด็กหญิง') || 
                student.name.startsWith('ด.ญ.')
            );
            
            // เรียงตามเลขประจำตัว
            maleStudents.sort((a, b) => a.id.localeCompare(b.id));
            femaleStudents.sort((a, b) => a.id.localeCompare(b.id));
            
            // รวมและกำหนดเลขที่ใหม่
            const sortedStudents = [...maleStudents, ...femaleStudents];
            sortedStudents.forEach((student, index) => {
                student.no = index + 1;
            });
            
            systemData.students[classId] = sortedStudents;
        }

        // ฟังก์ชันจัดการนักเรียน
        function loadStudents() {
            const classId = document.getElementById('studentClassSelect').value;
            if (!classId) {
                document.getElementById('studentManageList').innerHTML = '';
                return;
            }
            
            const students = systemData.students[classId] || [];
            const container = document.getElementById('studentManageList');
            
            container.innerHTML = students.map(student => `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 8px;">
                    <div>
                        <strong>${student.no}. ${student.name}</strong><br>
                        <small>รหัส: ${student.id}</small>
                    </div>
                    <div>
                        <button class="btn btn-warning" onclick="editStudent(${classId}, ${student.no})" style="margin-right: 5px; padding: 5px 10px;">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-danger" onclick="deleteStudent(${classId}, ${student.no})" style="padding: 5px 10px;">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        async function addStudent() {
            const classId = document.getElementById('studentClassSelect').value;
            const no = document.getElementById('newStudentNo').value;
            const id = document.getElementById('newStudentId').value.trim();
            const name = document.getElementById('newStudentName').value.trim();
            
            if (!classId || !no || !id || !name) {
                Swal.fire('ข้อผิดพลาด', 'กรุณากรอกข้อมูลให้ครบถ้วน', 'error');
                return;
            }
            
            const newStudent = {
                no: parseInt(no),
                id: id,
                name: name
            };
            
            try {
                const response = await sendToGoogleSheets({
                    action: 'addStudent',
                    classId: classId,
                    student: newStudent
                });
                
                if (response && response.success) {
                    if (!systemData.students[classId]) {
                        systemData.students[classId] = [];
                    }
                    
                    systemData.students[classId].push(newStudent);
                    reorderStudents(classId);
                    
                    // ล้างฟอร์ม
                    document.getElementById('newStudentNo').value = '';
                    document.getElementById('newStudentId').value = '';
                    document.getElementById('newStudentName').value = '';
                    
                    loadStudents();
                    displayClasses();
                    Swal.fire('สำเร็จ', 'เพิ่มนักเรียนเรียบร้อยแล้ว', 'success');
                } else {
                    throw new Error('Failed to add student');
                }
                
            } catch (error) {
                console.error('Error adding student:', error);
                Swal.fire('ข้อผิดพลาด', 'ไม่สามารถเพิ่มนักเรียนได้ กรุณาลองใหม่', 'error');
            }
        }

        function editStudent(classId, studentNo) {
            const student = systemData.students[classId].find(s => s.no === studentNo);
            if (!student) return;
            
            currentEdit = { type: 'student', classId, studentNo };
            document.getElementById('modalTitle').textContent = 'แก้ไขข้อมูลนักเรียน';
            document.getElementById('modalBody').innerHTML = `
                <div class="form-group">
                    <label class="form-label">เลขที่</label>
                    <input type="number" id="editStudentNo" class="form-control" value="${student.no}">
                </div>
                <div class="form-group">
                    <label class="form-label">เลขประจำตัว</label>
                    <input type="text" id="editStudentId" class="form-control" value="${student.id}">
                </div>
                <div class="form-group">
                    <label class="form-label">ชื่อ-สกุล</label>
                    <input type="text" id="editStudentName" class="form-control" value="${student.name}">
                </div>
            `;
            document.getElementById('editModal').classList.add('show');
        }

        async function deleteStudent(classId, studentNo) {
            Swal.fire({
                title: 'ยืนยันการลบ',
                text: 'คุณต้องการลบนักเรียนคนนี้หรือไม่? (จะลบข้อมูลการเข้าเรียนที่เกี่ยวข้องด้วย)',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'ลบ',
                cancelButtonText: 'ยกเลิก'
            }).then(async (result) => {
                if (result.isConfirmed) {
                    try {
                        // ลบข้อมูลการเข้าเรียนที่เกี่ยวข้อง
                        const response = await sendToGoogleSheets({
                            action: 'deleteStudentAttendance',
                            classId: classId,
                            studentNo: studentNo
                        });
                        
                        if (response && response.success) {
                            systemData.students[classId] = systemData.students[classId].filter(s => s.no !== studentNo);
                            reorderStudents(classId);
                            loadStudents();
                            displayClasses();
                            Swal.fire('สำเร็จ', 'ลบนักเรียนและข้อมูลการเข้าเรียนเรียบร้อยแล้ว', 'success');
                        } else {
                            throw new Error('Failed to delete student attendance');
                        }
                    } catch (error) {
                        console.error('Error deleting student:', error);
                        Swal.fire('ข้อผิดพลาด', 'ไม่สามารถลบข้อมูลได้ กรุณาลองใหม่', 'error');
                    }
                }
            });
        }

        async function clearAllStudents() {
            const classId = document.getElementById('studentClassSelect').value;
            if (!classId) {
                Swal.fire('ข้อผิดพลาด', 'กรุณาเลือกห้องเรียน', 'error');
                return;
            }
            
            Swal.fire({
                title: 'ยืนยันการลบ',
                text: 'คุณต้องการลบนักเรียนทั้งหมดในห้องนี้หรือไม่? (จะลบข้อมูลการเข้าเรียนที่เกี่ยวข้องทั้งหมดด้วย)',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'ลบทั้งหมด',
                cancelButtonText: 'ยกเลิก'
            }).then(async (result) => {
                if (result.isConfirmed) {
                    try {
                        // ลบข้อมูลการเข้าเรียนทั้งหมดของห้องนี้
                        const response = await sendToGoogleSheets({
                            action: 'deleteClassAttendance',
                            classId: classId
                        });
                        
                        if (response && response.success) {
                            systemData.students[classId] = [];
                            loadStudents();
                            displayClasses();
                            Swal.fire('สำเร็จ', 'ลบนักเรียนและข้อมูลการเข้าเรียนทั้งหมดเรียบร้อยแล้ว', 'success');
                        } else {
                            throw new Error('Failed to delete class attendance');
                        }
                    } catch (error) {
                        console.error('Error clearing students:', error);
                        Swal.fire('ข้อผิดพลาด', 'ไม่สามารถลบข้อมูลได้ กรุณาลองใหม่', 'error');
                    }
                }
            });
        }

        // ฟังก์ชันนำเข้าจาก Excel (แก้ไขแล้ว)
        function importFromExcel() {
            const file = document.getElementById('excelFile').files[0];
            const classId = document.getElementById('studentClassSelect').value;
            
            if (!file) return;
            if (!classId) {
                Swal.fire('ข้อผิดพลาด', 'กรุณาเลือกห้องเรียนก่อน', 'error');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
                    
                    // ข้ามแถวแรก (header) และประมวลผลข้อมูล
                    const students = [];
                    for (let i = 1; i < jsonData.length; i++) {
                        const row = jsonData[i];
                        if (row[0] && row[1] && row[2]) {
                            // รักษารูปแบบเลขประจำตัวนักเรียนตามที่อยู่ใน Excel
                            let studentId = row[1];
                            if (typeof studentId === 'number') {
                                // ถ้าเป็นตัวเลข ให้แปลงเป็น string โดยไม่ใช้ scientific notation
                                studentId = studentId.toString();
                            } else {
                                studentId = String(studentId);
                            }
                            
                            students.push({
                                no: parseInt(row[0]) || i,
                                id: studentId,
                                name: String(row[2])
                            });
                        }
                    }
                    
                    if (students.length > 0) {
                        // เก็บข้อมูลชั่วคราว
                        tempExcelData = {
                            classId: classId,
                            students: students
                        };
                        
                        // แสดงข้อมูลในหน้าจอ
                        systemData.students[classId] = students;
                        reorderStudents(classId);
                        loadStudents();
                        displayClasses();
                        
                        // แสดงปุ่มบันทึก
                        document.getElementById('saveExcelDataBtn').style.display = 'block';
                        
                        Swal.fire('สำเร็จ', `นำเข้าข้อมูลนักเรียน ${students.length} คน\nกรุณากดปุ่ม "บันทึกข้อมูลลง Google Sheets" เพื่อบันทึกข้อมูล`, 'success');
                    } else {
                        Swal.fire('ข้อผิดพลาด', 'ไม่พบข้อมูลในไฟล์', 'error');
                    }
                } catch (error) {
                    console.error('Error reading Excel:', error);
                    Swal.fire('ข้อผิดพลาด', 'ไม่สามารถอ่านไฟล์ได้', 'error');
                }
            };
            reader.readAsArrayBuffer(file);
        }

        // ฟังก์ชันบันทึกข้อมูล Excel ลง Google Sheets
        async function saveExcelDataToServer() {
            if (!tempExcelData) {
                Swal.fire('ข้อผิดพลาด', 'ไม่พบข้อมูลที่จะบันทึก', 'error');
                return;
            }
            
            try {
                const response = await sendToGoogleSheets({
                    action: 'saveAllStudents',
                    classId: tempExcelData.classId,
                    students: tempExcelData.students
                });
                
                if (response && response.success) {
                    // ซ่อนปุ่มบันทึก
                    document.getElementById('saveExcelDataBtn').style.display = 'none';
                    tempExcelData = null;
                    
                    Swal.fire('สำเร็จ', 'บันทึกข้อมูลลง Google Sheets เรียบร้อยแล้ว', 'success');
                } else {
                    throw new Error('Failed to save students to server');
                }
                
            } catch (error) {
                console.error('Error saving Excel data:', error);
                Swal.fire('ข้อผิดพลาด', 'ไม่สามารถบันทึกข้อมูลลง Google Sheets ได้ กรุณาลองใหม่', 'error');
            }
        }

        // ฟังก์ชันค้นหาประวัติ
        async function searchHistory() {
            const date = document.getElementById('historyDate').value;
            const classId = document.getElementById('historyClass').value;
            const subjectId = document.getElementById('historySubject').value;
            
            if (!date || !classId || !subjectId) {
                Swal.fire('ข้อผิดพลาด', 'กรุณาเลือกข้อมูลให้ครบถ้วน', 'error');
                return;
            }
            
            try {
                console.log('Searching history with:', { date, classId, subjectId });
                
                // แสดงการโหลด
                Swal.fire({
                    title: 'กำลังค้นหาข้อมูล',
                    text: 'กรุณารอสักครู่...',
                    allowOutsideClick: false,
                    didOpen: () => {
                        Swal.showLoading();
                    }
                });
                
                // ค้นหาจาก Google Sheets
                const response = await sendToGoogleSheets({
                    action: 'getAttendance',
                    date: date,
                    classId: parseInt(classId),
                    subjectId: parseInt(subjectId)
                });
                
                Swal.close();
                console.log('Search response:', response);
                
                const container = document.getElementById('historyResults');
                
                if (response && response.success && response.data && response.data.length > 0) {
                    const attendance = response.data;
                    const className = systemData.classes.find(c => c.id == classId)?.name;
                    const subjectName = systemData.subjects.find(s => s.id == subjectId)?.name;
                    
                    const statusCounts = {
                        present: attendance.filter(a => a.status === 'present').length,
                        absent: attendance.filter(a => a.status === 'absent').length,
                        leave: attendance.filter(a => a.status === 'leave').length,
                        sick: attendance.filter(a => a.status === 'sick').length,
                        activity: attendance.filter(a => a.status === 'activity').length
                    };
                    
                    const total = attendance.length;
                    
                    container.innerHTML = `
                        <div class="card">
                            <h4>ผลการค้นหา</h4>
                            <p><strong>วันที่:</strong> ${date}</p>
                            <p><strong>ห้องเรียน:</strong> ${className}</p>
                            <p><strong>รายวิชา:</strong> ${subjectName}</p>
                            
                            <div class="grid-3" style="margin: 20px 0;">
                                <div class="stats-card" style="background: linear-gradient(135deg, #2ecc71, #27ae60);">
                                    <div class="stats-number">${statusCounts.present}</div>
                                    <div class="stats-label">มาเรียน</div>
                                </div>
                                <div class="stats-card" style="background: linear-gradient(135deg, #e74c3c, #c0392b);">
                                    <div class="stats-number">${statusCounts.absent}</div>
                                    <div class="stats-label">ขาดเรียน</div>
                                </div>
                                <div class="stats-card" style="background: linear-gradient(135deg, #9b59b6, #8e44ad);">
                                    <div class="stats-number">${statusCounts.leave}</div>
                                    <div class="stats-label">ลากิจ</div>
                                </div>
                                <div class="stats-card" style="background: linear-gradient(135deg, #3498db, #2980b9);">
                                    <div class="stats-number">${statusCounts.sick}</div>
                                    <div class="stats-label">ลาป่วย</div>
                                </div>
                                <div class="stats-card" style="background: linear-gradient(135deg, #f39c12, #e67e22);">
                                    <div class="stats-number">${statusCounts.activity}</div>
                                    <div class="stats-label">กิจกรรม</div>
                                </div>
                            </div>
                            
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>เลขที่</th>
                                        <th>รหัสนักเรียน</th>
                                        <th>ชื่อ-สกุล</th>
                                        <th>สถานะ</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${attendance.map(student => `
                                        <tr>
                                            <td>${student.no}</td>
                                            <td>${student.studentId}</td>
                                            <td>${student.name}</td>
                                            <td>
                                                <span style="padding: 5px 10px; border-radius: 15px; color: white; font-weight: 600; 
                                                    background: ${getStatusColor(student.status)};">
                                                    ${getStatusText(student.status)}
                                                </span>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    `;
                } else {
                    container.innerHTML = `
                        <div class="card">
                            <h4>ผลการค้นหา</h4>
                            <p><strong>วันที่:</strong> ${date}</p>
                            <p><strong>ห้องเรียน:</strong> ${systemData.classes.find(c => c.id == classId)?.name}</p>
                            <p><strong>รายวิชา:</strong> ${systemData.subjects.find(s => s.id == subjectId)?.name}</p>
                            <p style="color: #666; font-style: italic; text-align: center; margin-top: 20px;">
                                ไม่พบข้อมูลการเข้าเรียนในวันที่ดังกล่าว
                            </p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error searching history:', error);
                Swal.fire('ข้อผิดพลาด', 'ไม่สามารถค้นหาข้อมูลได้ กรุณาลองใหม่', 'error');
            }
        }

        function getStatusColor(status) {
            const colors = {
                present: 'linear-gradient(135deg, #2ecc71, #27ae60)',
                absent: 'linear-gradient(135deg, #e74c3c, #c0392b)',
                leave: 'linear-gradient(135deg, #9b59b6, #8e44ad)',
                sick: 'linear-gradient(135deg, #3498db, #2980b9)',
                activity: 'linear-gradient(135deg, #f39c12, #e67e22)'
            };
            return colors[status] || colors.present;
        }

        function getStatusText(status) {
            const texts = {
                present: 'มาเรียน',
                absent: 'ขาดเรียน',
                leave: 'ลากิจ',
                sick: 'ลาป่วย',
                activity: 'กิจกรรม'
            };
            return texts[status] || 'มาเรียน';
        }

        // ฟังก์ชันสร้างรายงาน
        async function generateReport() {
            const startDate = document.getElementById('reportStartDate').value;
            const endDate = document.getElementById('reportEndDate').value;
            const classId = document.getElementById('reportClass').value;
            const subjectId = document.getElementById('reportSubject').value;
            
            if (!startDate || !endDate) {
                Swal.fire('ข้อผิดพลาด', 'กรุณาเลือกช่วงวันที่', 'error');
                return;
            }
            
            try {
                // แสดงการโหลด
                Swal.fire({
                    title: 'กำลังสร้างรายงาน',
                    text: 'กรุณารอสักครู่...',
                    allowOutsideClick: false,
                    didOpen: () => {
                        Swal.showLoading();
                    }
                });
                
                // ดึงข้อมูลจาก Google Sheets
                const response = await sendToGoogleSheets({
                    action: 'getReportData',
                    startDate: startDate,
                    endDate: endDate,
                    classId: classId || null,
                    subjectId: subjectId || null
                });
                
                Swal.close();
                
                if (response && response.success) {
                    const stats = response.data.stats || {
                        present: 0,
                        absent: 0,
                        leave: 0,
                        sick: 0,
                        activity: 0
                    };
                    
                    // แสดงสถิติ
                    const statsContainer = document.getElementById('statsContainer');
                    statsContainer.innerHTML = `
                        <div class="stats-card" style="background: linear-gradient(135deg, #2ecc71, #27ae60);">
                            <div class="stats-number">${stats.present}</div>
                            <div class="stats-label">มาเรียน</div>
                        </div>
                        <div class="stats-card" style="background: linear-gradient(135deg, #e74c3c, #c0392b);">
                            <div class="stats-number">${stats.absent}</div>
                            <div class="stats-label">ขาดเรียน</div>
                        </div>
                        <div class="stats-card" style="background: linear-gradient(135deg, #9b59b6, #8e44ad);">
                            <div class="stats-number">${stats.leave}</div>
                            <div class="stats-label">ลากิจ</div>
                        </div>
                        <div class="stats-card" style="background: linear-gradient(135deg, #3498db, #2980b9);">
                            <div class="stats-number">${stats.sick}</div>
                            <div class="stats-label">ลาป่วย</div>
                        </div>
                        <div class="stats-card" style="background: linear-gradient(135deg, #f39c12, #e67e22);">
                            <div class="stats-number">${stats.activity}</div>
                            <div class="stats-label">กิจกรรม</div>
                        </div>
                    `;
                    
                    // สร้างกราฟ
                    createChart(stats);
                    
                    Swal.fire('สำเร็จ', 'สร้างรายงานเรียบร้อยแล้ว', 'success');
                } else {
                    throw new Error('Failed to generate report');
                }
                
            } catch (error) {
                console.error('Error generating report:', error);
                Swal.fire('ข้อผิดพลาด', 'ไม่สามารถสร้างรายงานได้ กรุณาลองใหม่', 'error');
            }
        }

        function createChart(stats) {
            const ctx = document.getElementById('attendanceChart').getContext('2d');
            
            if (attendanceChart) {
                attendanceChart.destroy();
            }
            
            attendanceChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['มาเรียน', 'ขาดเรียน', 'ลากิจ', 'ลาป่วย', 'กิจกรรม'],
                    datasets: [{
                        data: [stats.present, stats.absent, stats.leave, stats.sick, stats.activity],
                        backgroundColor: [
                            '#2ecc71',
                            '#e74c3c',
                            '#9b59b6',
                            '#3498db',
                            '#f39c12'
                        ],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                font: {
                                    family: 'Sarabun',
                                    size: 14
                                }
                            }
                        }
                    }
                }
            });
        }

        // ฟังก์ชันสร้างรายงาน PDF
        async function generatePDFReport() {
            const startDate = document.getElementById('reportStartDate').value;
            const endDate = document.getElementById('reportEndDate').value;
            const classId = document.getElementById('reportClass').value;
            const subjectId = document.getElementById('reportSubject').value;
            
            if (!startDate || !endDate || !classId || !subjectId) {
                Swal.fire('ข้อผิดพลาด', 'กรุณาเลือกข้อมูลให้ครบถ้วน (วันที่เริ่มต้น, วันที่สิ้นสุด, ห้องเรียน, และรายวิชา)', 'error');
                return;
            }
            
            try {
                // แสดงการโหลด
                Swal.fire({
                    title: 'กำลังสร้างรายงาน PDF',
                    text: 'กรุณารอสักครู่...',
                    allowOutsideClick: false,
                    didOpen: () => {
                        Swal.showLoading();
                    }
                });
                
                // ดึงข้อมูลรายละเอียดการเข้าเรียน
                const response = await sendToGoogleSheets({
                    action: 'getDetailedReportData',
                    startDate: startDate,
                    endDate: endDate,
                    classId: classId,
                    subjectId: subjectId
                });
                
                Swal.close();
                
                if (response && response.success) {
                    const reportData = response.data;
                    createPDFReport(reportData, startDate, endDate, classId, subjectId);
                } else {
                    throw new Error('Failed to get detailed report data');
                }
                
            } catch (error) {
                console.error('Error generating PDF report:', error);
                Swal.fire('ข้อผิดพลาด', 'ไม่สามารถสร้างรายงาน PDF ได้ กรุณาลองใหม่', 'error');
            }
        }

        async function createPDFReport(reportData, startDate, endDate, classId, subjectId) {
            try {
                // ส่งข้อมูลไป Google Apps Script เพื่อสร้าง PDF
                const response = await sendToGoogleSheets({
                    action: 'generatePDF',
                    reportData: reportData,
                    startDate: startDate,
                    endDate: endDate,
                    classId: classId,
                    subjectId: subjectId,
                    className: systemData.classes.find(c => c.id == classId)?.name || '',
                    subjectName: systemData.subjects.find(s => s.id == subjectId)?.name || ''
                });
                
                if (response && response.success && response.pdfUrl) {
                    // เปิด PDF ในแท็บใหม่
                    window.open(response.pdfUrl, '_blank');
                    Swal.fire('สำเร็จ', 'สร้างรายงาน PDF เรียบร้อยแล้ว', 'success');
                } else {
                    throw new Error('Failed to generate PDF');
                }
                
            } catch (error) {
                console.error('Error creating PDF:', error);
                Swal.fire('ข้อผิดพลาด', 'ไม่สามารถสร้างรายงาน PDF ได้ กรุณาลองใหม่', 'error');
            }
        }

        function getStatusSymbol(status) {
            const symbols = {
                present: '/',
                absent: 'ข',
                leave: 'ล',
                sick: 'ป',
                activity: 'ก'
            };
            return symbols[status] || '';
        }

        function formatDateThai(dateString) {
            const date = new Date(dateString);
            const day = date.getDate().toString().padStart(2, '0');
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const year = date.getFullYear();
            return `${day}/${month}/${year}`;
        }

        function formatDateShort(dateString) {
            const date = new Date(dateString);
            const day = date.getDate().toString().padStart(2, '0');
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            return `${day}/${month}`;
        }

        // ฟังก์ชัน Modal
        function saveEdit() {
            if (!currentEdit) return;
            
            if (currentEdit.type === 'class') {
                const newName = document.getElementById('editInput').value.trim();
                if (!newName) {
                    Swal.fire('ข้อผิดพลาด', 'กรุณาใส่ชื่อห้องเรียน', 'error');
                    return;
                }
                
                const cls = systemData.classes.find(c => c.id === currentEdit.id);
                if (cls) {
                    cls.name = newName;
                    updateAllSelects();
                    displayClasses();
                    closeModal();
                    Swal.fire('สำเร็จ', 'แก้ไขห้องเรียนเรียบร้อยแล้ว', 'success');
                }
            } else if (currentEdit.type === 'subject') {
                const newName = document.getElementById('editInput').value.trim();
                if (!newName) {
                    Swal.fire('ข้อผิดพลาด', 'กรุณาใส่ชื่อรายวิชา', 'error');
                    return;
                }
                
                const subject = systemData.subjects.find(s => s.id === currentEdit.id);
                if (subject) {
                    subject.name = newName;
                    updateAllSelects();
                    displaySubjects();
                    closeModal();
                    Swal.fire('สำเร็จ', 'แก้ไขรายวิชาเรียบร้อยแล้ว', 'success');
                }
            } else if (currentEdit.type === 'student') {
                const no = parseInt(document.getElementById('editStudentNo').value);
                const id = document.getElementById('editStudentId').value.trim();
                const name = document.getElementById('editStudentName').value.trim();
                
                if (!no || !id || !name) {
                    Swal.fire('ข้อผิดพลาด', 'กรุณากรอกข้อมูลให้ครบถ้วน', 'error');
                    return;
                }
                
                const student = systemData.students[currentEdit.classId].find(s => s.no === currentEdit.studentNo);
                if (student) {
                    student.no = no;
                    student.id = id;
                    student.name = name;
                    
                    reorderStudents(currentEdit.classId);
                    
                    loadStudents();
                    displayClasses();
                    closeModal();
                    Swal.fire('สำเร็จ', 'แก้ไขข้อมูลนักเรียนเรียบร้อยแล้ว', 'success');
                }
            }
        }

        function closeModal() {
            document.getElementById('editModal').classList.remove('show');
            currentEdit = null;
        }
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'976946dbf549a192',t:'MTc1NjQ0MTQ0Ni4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
