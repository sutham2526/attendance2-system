<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠ & ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<style>
body{font-family:"Sarabun",sans-serif;background:#f7f9fc;margin:0;padding:0;}
header{background:#4a90e2;color:white;padding:15px;text-align:center;font-size:22px;}
nav{display:flex;justify-content:center;margin:20px;}
nav button{margin:0 10px;padding:10px 20px;border:none;border-radius:8px;cursor:pointer;background:#50c878;color:white;font-size:16px;}
section{display:none;padding:20px;}
section.active{display:block;}
table{border-collapse:collapse;width:100%;margin-top:10px;background:white;}
th,td{border:1px solid #ddd;padding:8px;text-align:left;}
th{background:#4a90e2;color:white;}
.btn{padding:6px 12px;border:none;border-radius:6px;cursor:pointer;}
.btn-green{background:#50c878;color:white;}
.btn-blue{background:#4a90e2;color:white;}
.btn-red{background:#e94e77;color:white;}
</style>
</head>
<body>

<header>üìö ‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠ & ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</header>

<nav>
  <button onclick="showSection('attendance')">‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠</button>
  <button onclick="showSection('manageClasses')">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</button>
  <button onclick="showSection('report')">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•</button>
</nav>

<!-- ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠ -->
<section id="attendance" class="active">
<h2>‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h2>
<label>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô:</label>
<select id="classSelect" onchange="loadStudentsForAttendance()"></select>
<div id="attendanceArea"></div>
<button class="btn btn-green" onclick="saveAttendance()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠</button>
</section>

<!-- ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô -->
<section id="manageClasses">
<h2>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h2>
<input type="text" id="newClassName" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô">
<button class="btn btn-green" onclick="addClass()">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</button>
<div id="classList"></div>
</section>

<!-- ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô -->
<section id="report">
<h2>üìä ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•</h2>
<label>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô:</label>
<select id="reportClassroom"></select>
<label>‡∏à‡∏≤‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</label>
<input type="date" id="startDate">
<label>‡∏ñ‡∏∂‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</label>
<input type="date" id="endDate">
<button onclick="loadReport()">‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</button>

<h3>‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•</h3>
<table id="reportTable">
<thead>
<tr>
<th>‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</th>
<th>‡∏°‡∏≤</th>
<th>‡∏Ç‡∏≤‡∏î</th>
<th>‡∏™‡∏≤‡∏¢</th>
<th>‡∏•‡∏≤‡∏Å‡∏¥‡∏à</th>
<th>‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢</th>
<th>‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</th>
<th>% ‡∏°‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</th>
</tr>
</thead>
<tbody></tbody>
</table>

<h3>‡∏Å‡∏£‡∏≤‡∏ü‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•</h3>
<canvas id="reportChart" width="400" height="200"></canvas>
<button class="btn btn-blue" onclick="exportExcel()">Export Excel</button>
<button class="btn btn-red" onclick="exportPDF()">Export PDF</button>
</section>

<script>
// =================== ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ===================
let classrooms={}; // ‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô -> list ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô [{id,name}]
let attendanceData=[]; // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠

// =================== ‡πÅ‡∏™‡∏î‡∏á Section ===================
function showSection(id){
  document.querySelectorAll("section").forEach(sec=>sec.classList.remove("active"));
  document.getElementById(id).classList.add("active");
  if(id=="attendance") refreshClassSelect();
  if(id=="manageClasses") renderClasses();
  if(id=="report") refreshReportClass();
}

// =================== ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô ===================
function addClass(){
  let name=document.getElementById("newClassName").value.trim();
  if(!name) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô");
  if(classrooms[name]) return alert("‡∏°‡∏µ‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡πâ‡∏ß");
  classrooms[name]=[];
  document.getElementById("newClassName").value="";
  renderClasses(); refreshClassSelect(); refreshReportClass();
}

function renderClasses(){
  let container=document.getElementById("classList"); container.innerHTML="";
  for(let c in classrooms){
    let div=document.createElement("div");
    div.innerHTML=`<b>${c}</b> (${classrooms[c].length})
    <button class='btn btn-blue' onclick="manageStudents('${c}')">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</button>
    <button class='btn btn-red' onclick="deleteClass('${c}')">‡∏•‡∏ö</button>`;
    container.appendChild(div);
  }
}

function deleteClass(c){ if(confirm("‡∏•‡∏ö‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô "+c+" ?")){ delete classrooms[c]; renderClasses(); refreshClassSelect(); refreshReportClass(); } }

// =================== ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô ===================
function manageStudents(className){
  let list=classrooms[className];
  let html=`<h3>‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÉ‡∏ô‡∏´‡πâ‡∏≠‡∏á ${className}</h3>
  <input id="stuId" placeholder="‡∏£‡∏´‡∏±‡∏™">
  <input id="stuName" placeholder="‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•">
  <button class="btn btn-green" onclick="addStudent('${className}')">‡πÄ‡∏û‡∏¥‡πà‡∏°</button>
  <table><tr><th>‡∏£‡∏´‡∏±‡∏™</th><th>‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•</th></tr>`;
  list.forEach(s=>html+=`<tr><td>${s.id}</td><td>${s.name}</td></tr>`);
  html+="</table>";
  document.getElementById("classList").innerHTML=html;
}

function addStudent(className){
  let id=document.getElementById("stuId").value.trim();
  let name=document.getElementById("stuName").value.trim();
  if(!id||!name)return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡πÅ‡∏•‡∏∞‡∏ä‡∏∑‡πà‡∏≠");
  classrooms[className].push({id,name});
  manageStudents(className);
}

// =================== ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠ ===================
function refreshClassSelect(){
  let sel=document.getElementById("classSelect"); sel.innerHTML="<option value=''>--‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô--</option>";
  for(let c in classrooms) sel.innerHTML+=`<option>${c}</option>`;
}

function loadStudentsForAttendance(){
  let c=document.getElementById("classSelect").value;
  if(!c) return;
  let list=classrooms[c];
  
  attendanceData = list.map(s => ({id:s.id, name:s.name, status: "‡∏Ç‡∏≤‡∏î"})); // default ‡∏Ç‡∏≤‡∏î
  let html="<table><tr><th>‡∏£‡∏´‡∏±‡∏™</th><th>‡∏ä‡∏∑‡πà‡∏≠</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th></tr>";
  
  list.forEach((s,i)=>{
    html+=`<tr>
      <td>${s.id}</td>
      <td>${s.name}</td>
      <td>
        <select onchange="attendanceData[${i}].status=this.value" style="padding:4px;">
          <option value='‡∏°‡∏≤' style="background:#50c878;color:white;">‡∏°‡∏≤</option>
          <option value='‡∏Ç‡∏≤‡∏î' selected style="background:#e94e77;color:white;">‡∏Ç‡∏≤‡∏î</option>
          <option value='‡∏™‡∏≤‡∏¢' style="background:#f1c40f;color:white;">‡∏™‡∏≤‡∏¢</option>
          <option value='‡∏•‡∏≤‡∏Å‡∏¥‡∏à' style="background:#9b59b6;color:white;">‡∏•‡∏≤‡∏Å‡∏¥‡∏à</option>
          <option value='‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢' style="background:#e67e22;color:white;">‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢</option>
          <option value='‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°' style="background:#f39c12;color:white;">‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</option>
        </select>
      </td>
    </tr>`;
  });
  html+="</table>";
  document.getElementById("attendanceArea").innerHTML=html;
}

function saveAttendance(){
  if(attendanceData.length===0) return alert("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô");
  console.log("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠", attendanceData);
  alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢! (‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡πà‡∏á‡πÑ‡∏õ Google Sheets ‡πÑ‡∏î‡πâ)");
}

// =================== ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô ===================
function refreshReportClass(){
  let sel=document.getElementById("reportClassroom"); sel.innerHTML="<option value=''>--‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô--</option>";
  for(let c in classrooms) sel.innerHTML+=`<option>${c}</option>`;
}

function loadReport(){
  let className=document.getElementById("reportClassroom").value;
  if(!className)return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô");

  let report={};
  attendanceData.forEach(s=>{
    if(!report[s.name]) report[s.name]={‡∏°‡∏≤:0,‡∏Ç‡∏≤‡∏î:0,‡∏™‡∏≤‡∏¢:0,‡∏•‡∏≤‡∏Å‡∏¥‡∏à:0,‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢:0,‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°:0};
    report[s.name][s.status] += 1;
  });

  let reportArray=[];
  for(let name in report){
    let r=report[name];
    let total = r.‡∏°‡∏≤+r.‡∏Ç‡∏≤‡∏î+r.‡∏™‡∏≤‡∏¢+r.‡∏•‡∏≤‡∏Å‡∏¥‡∏à+r.‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢+r.‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°;
    let percent = total>0 ? Math.round((r.‡∏°‡∏≤/total)*100) : 0;
    reportArray.push({name,...r,percent});
  }
  renderReport(reportArray);
}

function renderReport(report){
  let tbody=document.getElementById("reportTable").querySelector("tbody"); tbody.innerHTML="";
  report.forEach(r=>{
    tbody.innerHTML+=`<tr>
      <td>${r.name}</td>
      <td>${r.‡∏°‡∏≤}</td>
      <td>${r.‡∏Ç‡∏≤‡∏î}</td>
      <td>${r.‡∏™‡∏≤‡∏¢}</td>
      <td>${r.‡∏•‡∏≤‡∏Å‡∏¥‡∏à}</td>
      <td>${r.‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢}</td>
      <td>${r.‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°}</td>
      <td>${r.percent}</td>
    </tr>`;
  });

  const ctx=document.getElementById("reportChart").getContext("2d");
  if(window.myChart) window.myChart.destroy();
  window.myChart = new Chart(ctx,{
    type:'bar',
    data:{
      labels:report.map(r=>r.name),
      datasets:[
        {label:"‡∏°‡∏≤",data:report.map(r=>r.‡∏°‡∏≤),backgroundColor:"#50c878"},
        {label:"‡∏Ç‡∏≤‡∏î",data:report.map(r=>r.‡∏Ç‡∏≤‡∏î),backgroundColor:"#e94e77"},
        {label:"‡∏™‡∏≤‡∏¢",data:report.map(r=>r.‡∏™‡∏≤‡∏¢),backgroundColor:"#f1c40f"},
        {label:"‡∏•‡∏≤‡∏Å‡∏¥‡∏à",data:report.map(r=>r.‡∏•‡∏≤‡∏Å‡∏¥‡∏à),backgroundColor:"#9b59b6"},
        {label:"‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢",data:report.map(r=>r.‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢),backgroundColor:"#e67e22"},
        {label:"‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°",data:report.map(r=>r.‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°),backgroundColor:"#f39c12"}
      ]
    },
    options:{responsive:true,plugins:{legend:{position:'top'}},scales:{y:{beginAtZero:true}}}
  });
}

// =================== Export ===================
function exportExcel(){
  let wb=XLSX.utils.book_new();
  let tbl=document.getElementById("reportTable");
  let ws=XLSX.utils.table_to_sheet(tbl);
  XLSX.utils.book_append_sheet(wb,ws,"Report");
  XLSX.writeFile(wb,"Attendance_Report.xlsx");
}

function exportPDF(){
  let element=document.getElementById("reportTable");
  html2pdf().set({margin:0.5,filename:"Attendance_Report.pdf",html2canvas:{scale:2}}).from(element).save();
}
</script>
</body>
</html>
